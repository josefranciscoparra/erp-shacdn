// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== SPRINT 0: MODELOS B√ÅSICOS ====================
// Empezamos solo con lo m√≠nimo para autenticaci√≥n y multi-tenancy

model Organization {
  id        String   @id @default(cuid())
  name      String
  vat       String?  @unique // NIF de empresa
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Configuraci√≥n de estructura organizacional
  hierarchyType HierarchyType @default(DEPARTMENTAL) // Tipo de jerarqu√≠a de la organizaci√≥n

  // Configuraci√≥n de aprobaciones por tipo de solicitud (flujo configurable)
  approvalSettings        Json    @default("{}")
  groupHrApprovalsEnabled Boolean @default(true) // Permitir RRHH del grupo en aprobaciones

  // Configuraci√≥n de identidad de empleados (numeraci√≥n autom√°tica)
  employeeNumberPrefix  String? // Prefijo para n√∫meros de empleado (ej: "TMNW", "ACME")
  employeeNumberCounter Int     @default(0) // Contador at√≥mico para generar n√∫meros √∫nicos

  // Configuraci√≥n de validaci√≥n de emails corporativos
  allowedEmailDomains String[] @default([]) // Dominios de email permitidos (ej: ["acme.com", "acme.es"])

  // Configuraci√≥n de PTO (Vacaciones)
  annualPtoDays        Int    @default(23) // D√≠as de vacaciones anuales por defecto
  ptoCalculationMethod String @default("PROPORTIONAL") // PROPORTIONAL, FIXED
  ptoAccrualStartDate  String @default("CONTRACT_START") // CONTRACT_START, YEAR_START

  // Configuraci√≥n de Geolocalizaci√≥n
  geolocationEnabled     Boolean @default(false) // Activar/desactivar captura de geolocalizaci√≥n
  geolocationRequired    Boolean @default(false) // Si es obligatorio tener ubicaci√≥n para fichar
  geolocationMinAccuracy Int     @default(100) // Precisi√≥n m√≠nima requerida en metros
  geolocationMaxRadius   Int     @default(200) // Radio m√°ximo permitido por defecto en metros

  // Configuraci√≥n de Validaciones de Fichajes
  clockInToleranceMinutes                  Int     @default(15) // Tolerancia para entrada (minutos de retraso aceptables)
  clockOutToleranceMinutes                 Int     @default(15) // Tolerancia para salida (minutos de retraso aceptables)
  earlyClockInToleranceMinutes             Int     @default(30) // Tolerancia para entrada anticipada (minutos antes del horario)
  lateClockOutToleranceMinutes             Int     @default(30) // Tolerancia para salida tard√≠a (minutos despu√©s del horario)
  nonWorkdayClockInAllowed                 Boolean @default(false) // Permitir fichar en d√≠as no laborables
  nonWorkdayClockInWarning                 Boolean @default(true) // Mostrar warning al fichar en d√≠a no laboral
  autoCloseMissingClockOutEnabled          Boolean @default(false) // Cerrar autom√°ticamente fichajes abiertos al superar un % de jornada
  autoCloseMissingClockOutThresholdPercent Int     @default(150) // % de jornada para autocierre (ej: 150 = 1.5x)

  // Configuraci√≥n de Alertas de Fichajes (Sistema Avanzado)
  criticalLateArrivalMinutes    Int      @default(30) // Minutos de retraso para considerar alerta CR√çTICA (>15 warning, >30 cr√≠tico)
  criticalEarlyDepartureMinutes Int      @default(30) // Minutos de salida temprana para alerta CR√çTICA
  alertsEnabled                 Boolean  @default(true) // Activar/desactivar sistema de alertas de fichajes
  alertsRequireResolution       Boolean  @default(true) // Requerir resolucion manual de alertas
  alertNotificationsEnabled     Boolean  @default(false) // Enviar notificaciones a RRHH/managers sobre alertas
  alertNotificationRoles        String[] @default(["RRHH"]) // Roles que reciben notificaciones de alertas

  // Configuraci√≥n de Chat
  chatEnabled Boolean @default(false) // Activar/desactivar m√≥dulo de chat 1:1

  // Configuraci√≥n de Turnos
  shiftsEnabled              Boolean @default(false) // Activar/desactivar m√≥dulo de gesti√≥n de turnos
  shiftMinRestMinutes        Int     @default(720) // Descanso m√≠nimo entre turnos (por defecto 12h)
  shiftChangeRequestsEnabled Boolean @default(true) // Permitir solicitudes de cambio de turno desde empleados

  // Feature flags (DEPRECATED: migrar a campos booleanos espec√≠ficos)
  features Json @default("{}") // Feature flags JSON: { chat: true, ... }

  // M√©tricas de almacenamiento (Cloudflare R2 / provider seleccionado)
  // CR√çTICO: BigInt para soportar hasta 100GB (Int32 max = 2.1GB)
  storageUsedBytes     BigInt @default(0)
  storageLimitBytes    BigInt @default(1073741824) // 1GB por defecto, personalizable por plan
  storageReservedBytes BigInt @default(0) // Bytes reservados pendientes de commit

  // Relaciones
  users                        User[]
  userOrganizations            UserOrganization[]
  organizationGroupMemberships OrganizationGroupOrganization[]
  employees                    Employee[]
  costCenters                  CostCenter[]
  departments                  Department[]
  positions                    Position[]
  positionLevels               PositionLevel[]
  employmentContracts          EmploymentContract[]
  employeeDocuments            EmployeeDocument[]
  storedFiles                  StoredFile[]
  temporaryPasswords           TemporaryPassword[]
  supportImpersonationTokens   SupportImpersonationToken[]
  calendars                    Calendar[]
  timeClockTerminals           TimeClockTerminal[]
  timeEntries                  TimeEntry[]
  workdaySummaries             WorkdaySummary[]
  absenceTypes                 AbsenceType[]
  ptoBalances                  PtoBalance[]
  ptoRequests                  PtoRequest[]
  ptoNotifications             PtoNotification[]
  ptoBalanceAdjustments        PtoBalanceAdjustment[]
  recurringPtoAdjustments      RecurringPtoAdjustment[]
  ptoConfig                    OrganizationPtoConfig?
  signableDocuments            SignableDocument[]
  signatureRequests            SignatureRequest[]
  manualTimeEntryRequests      ManualTimeEntryRequest[]
  expenses                     Expense[]
  expenseProcedures            ExpenseProcedure[]
  expenseReports               ExpenseReport[]
  projects                     Project[] // Sistema de proyectos (Mejora 4)
  expensePolicy                ExpensePolicy?
  expenseApprovers             ExpenseApprover[] // Aprobadores de gastos organizacionales (multi-nivel)
  timeBankSettings             TimeBankSettings?
  timeBankMovements            TimeBankMovement[]
  timeBankRequests             TimeBankRequest[]
  overworkAuthorizations       OverworkAuthorization[]

  // Configuraci√≥n de Gastos (P√∫blico vs Privado)
  expenseMode ExpenseMode @default(PRIVATE)

  geolocationConsents    GeolocationConsent[] // Consentimientos de geolocalizaci√≥n
  sensitiveDataAccess    SensitiveDataAccess[] // Logs de acceso a datos sensibles
  conversations          Conversation[] // Conversaciones de chat
  messages               Message[] // Mensajes de chat
  dismissedNotifications DismissedNotification[] // Notificaciones descartadas
  organizationSetupJobs  OrganizationSetupJob[] // Jobs de configuraci√≥n guiada

  // NUEVAS relaciones para Sistema de Horarios V2.0
  scheduleTemplates ScheduleTemplate[]
  manualAssignments ManualShiftAssignment[]
  rotationPatterns  ShiftRotationPattern[]
  exceptionDays     ExceptionDayOverride[]
  workZones         WorkZone[]

  // Sistema de permisos y alertas
  areaResponsibles   AreaResponsible[]
  alertSubscriptions AlertSubscription[]
  alerts             Alert[]

  // NUEVO: Equipos de la organizaci√≥n
  teams Team[]

  // NUEVO: Contextos activos de usuarios
  userActiveContexts  UserActiveContext[]
  ManualShiftTemplate ManualShiftTemplate[]

  // Audit logs
  auditLogs AuditLog[]

  // NUEVO: Liquidaciones de vacaciones (Mejora 1)
  vacationSettlements VacationSettlement[]

  // NUEVO: Sistema de n√≥minas masivas (Mejora 3)
  payslipBatches     PayslipBatch[]
  payslipUploadItems PayslipUploadItem[]

  // NUEVO: Sistema de firma masiva (Mejora 7)
  signatureBatches SignatureBatch[]

  // NUEVO: Canal de Denuncias (Ley 2/2023)
  whistleblowingEnabled    Boolean  @default(false) // Activar/desactivar canal de denuncias
  whistleblowingPublicSlug String?  @unique // Slug para URL p√∫blica: /whistleblowing/[slug]
  whistleblowingManagerIds String[] @default([]) // IDs de usuarios gestores

  // Relaciones de Canal de Denuncias
  whistleblowingCategories WhistleblowingCategory[]
  whistleblowingReports    WhistleblowingReport[]

  // Importaciones masivas de empleados
  employeeImportJobs EmployeeImportJob[]

  // Sistema de reservas de storage
  storageReservations StorageReservation[]

  // Overrides de permisos por rol (Enterprise v1)
  rolePermissionOverrides OrgRolePermissionOverride[]
  OvertimeCandidate       OvertimeCandidate[]

  @@map("organizations")
}

model OrganizationGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations OrganizationGroupOrganization[]
  members       OrganizationGroupUser[]

  @@map("organization_groups")
}

enum OrganizationGroupOrganizationStatus {
  PENDING
  ACTIVE
  REJECTED
}

model OrganizationGroupOrganization {
  id             String                              @id @default(cuid())
  groupId        String
  organizationId String
  status         OrganizationGroupOrganizationStatus @default(PENDING)
  requestedById  String?
  approvedById   String?
  approvedAt     DateTime?
  createdAt      DateTime                            @default(now())
  updatedAt      DateTime                            @updatedAt

  group        OrganizationGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([groupId, organizationId])
  @@index([groupId])
  @@index([organizationId])
  @@map("organization_group_organizations")
}

model OrganizationGroupUser {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  role      Role     @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group OrganizationGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("organization_group_users")
}

// Configuraci√≥n global del sistema (singleton)
model GlobalSettings {
  id                                            String   @id @default("global")
  overtimeReconciliationWeekday                 Int      @default(1) // 1=Lunes ... 7=Domingo
  overtimeReconciliationHour                    Int      @default(2) // 0-23
  overtimeReconciliationWindowMinutes           Int      @default(15)
  overtimeReconciliationDispatchIntervalMinutes Int      @default(10)
  overtimeDailySweepHour                        Int      @default(4) // 0-23
  overtimeDailySweepWindowMinutes               Int      @default(20)
  overtimeDailySweepLookbackDays                Int      @default(2)
  createdAt                                     DateTime @default(now())
  updatedAt                                     DateTime @updatedAt

  @@map("global_settings")
}

// Sistema de reservas de storage para uploads at√≥micos
// Evita race conditions: 2 uploads simult√°neos no pueden superar el l√≠mite
model StorageReservation {
  id        String       @id @default(cuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  bytes     BigInt // Bytes reservados (BigInt para soportar archivos grandes)
  expiresAt DateTime // Expiraci√≥n de la reserva (30 min por defecto)
  createdAt DateTime     @default(now())
  userId    String? // Auditor√≠a: qui√©n reserv√≥
  fileKey   String? // Trazabilidad opcional: clave del archivo

  @@index([orgId])
  @@index([expiresAt])
  @@map("storage_reservations")
}

/// Overrides de permisos por rol a nivel de organizaci√≥n (Enterprise v1)
/// Permite a√±adir (grant) o quitar (revoke) permisos a un rol espec√≠fico
/// F√≥rmula: effectivePermissions = roleBase + grants - revokes
model OrgRolePermissionOverride {
  id                String   @id @default(cuid())
  orgId             String
  role              Role
  grantPermissions  String[] @default([]) // Permisos a a√±adir al rol
  revokePermissions String[] @default([]) // Permisos a quitar del rol
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdById       String? // Auditor√≠a: qui√©n cre√≥ (solo ID, sin relaci√≥n)
  updatedById       String? // Auditor√≠a: qui√©n actualiz√≥ (solo ID, sin relaci√≥n)

  // Relaci√≥n a Organization (necesaria para cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, role])
  @@index([orgId])
  @@map("org_role_permission_overrides")
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  password           String
  name               String
  role               Role      @default(EMPLOYEE)
  emailVerified      DateTime?
  image              String?
  active             Boolean   @default(true)
  mustChangePassword Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Seguridad de contrase√±a
  lastPasswordChangeAt   DateTime? // Fecha del √∫ltimo cambio de contrase√±a
  failedPasswordAttempts Int       @default(0) // Intentos fallidos de login
  passwordLockedUntil    DateTime? // Cuenta bloqueada hasta esta fecha

  // Multi-tenancy
  orgId                        String
  organization                 Organization            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userOrganizations            UserOrganization[]
  organizationGroupMemberships OrganizationGroupUser[]

  // Relaciones
  sessions                          Session[]
  employee                          Employee? // Un usuario puede estar vinculado a un empleado
  uploadedDocuments                 EmployeeDocument[]          @relation("DocumentUploader") // Documentos que ha subido
  temporaryPasswords                TemporaryPassword[] // Contrase√±as temporales generadas para este usuario
  createdTempPasswords              TemporaryPassword[]         @relation("CreatedBy") // Contrase√±as temporales que ha creado
  supportImpersonationTokens        SupportImpersonationToken[] // Tokens de suplantaci√≥n creados para este usuario
  createdSupportImpersonationTokens SupportImpersonationToken[] @relation("SupportImpersonationCreatedBy")
  approvedPtoRequests               PtoRequest[]                @relation("PtoApprover") // Solicitudes que ha aprobado/rechazado
  createdPtoRequests                PtoRequest[]                @relation("PtoRequestCreator") // Solicitudes PTO creadas
  ptoNotifications                  PtoNotification[] // Notificaciones recibidas
  ptoBalanceAdjustments             PtoBalanceAdjustment[] // Ajustes de PTO que ha realizado
  recurringPtoAdjustments           RecurringPtoAdjustment[] // Ajustes recurrentes que ha creado
  createdSignableDocuments          SignableDocument[] // Documentos firmables que ha creado
  approvedManualTimeEntries         ManualTimeEntryRequest[]    @relation("ManualTimeEntryApprover") // Solicitudes de fichaje manual que ha aprobado/rechazado
  createdExpenses                   Expense[]                   @relation("ExpenseCreator") // Gastos creados
  createdProcedures                 ExpenseProcedure[]          @relation("ProcedureCreator") // Expedientes de gasto creados
  reimbursedExpenses                Expense[]                   @relation("ExpenseReimburser") // Gastos que he reembolsado
  expenseApprovals                  ExpenseApproval[] // Aprobaciones de gastos
  expenseApproverRoles              ExpenseApprover[]           @relation("ExpenseApproverRoles") // Organizaciones donde soy aprobador de gastos
  employeesIApprove                 Employee[]                  @relation("EmployeeExpenseApprover") // Empleados de los que soy aprobador espec√≠fico
  geolocationConsents               GeolocationConsent[] // Consentimientos de geolocalizaci√≥n dados
  sensitiveDataAccess               SensitiveDataAccess[] // Logs de acceso a datos sensibles
  conversationsAsUserA              Conversation[]              @relation("ConversationUserA") // Conversaciones donde soy UserA
  conversationsAsUserB              Conversation[]              @relation("ConversationUserB") // Conversaciones donde soy UserB
  messagesSent                      Message[] // Mensajes enviados
  employeeImportJobs                EmployeeImportJob[]
  dismissedNotifications            DismissedNotification[] // Notificaciones descartadas por el usuario
  createdExceptions                 ExceptionDayOverride[]      @relation("CreatedExceptions") // Excepciones de horario que he creado
  deletedExceptions                 ExceptionDayOverride[]      @relation("DeletedExceptions") // Excepciones de horario que he eliminado
  createdTimeBankMovements          TimeBankMovement[]          @relation("TimeBankMovementCreator")
  approvedTimeBankMovements         TimeBankMovement[]          @relation("TimeBankMovementApprover")
  reviewedTimeBankRequests          TimeBankRequest[]           @relation("TimeBankRequestReviewer")
  processedTimeBankRequests         TimeBankRequest[]           @relation("TimeBankRequestProcessor")
  overworkRequestsCreated           OverworkAuthorization[]     @relation("OverworkAuthorizationRequester")
  overworkRequestsApproved          OverworkAuthorization[]     @relation("OverworkAuthorizationApprover")
  timeBankSettingsCreated           TimeBankSettings[]          @relation("TimeBankSettingsCreatedBy")
  timeBankSettingsUpdated           TimeBankSettings[]          @relation("TimeBankSettingsUpdatedBy")
  uploadedPtoDocuments              PtoRequestDocument[] // üÜï Justificantes de ausencia que ha subido

  // NUEVO: Sistema de n√≥minas masivas (Mejora 3)
  uploadedPayslipBatches PayslipBatch[] @relation("BatchUploader") // Lotes de n√≥minas que ha subido

  // Fortalecimiento n√≥minas: relaciones de publicaci√≥n/revocaci√≥n
  publishedPayslipBatches  PayslipBatch[]      @relation("BatchPublisher") // Lotes que ha publicado
  revokedPayslipBatches    PayslipBatch[]      @relation("BatchRevoker") // Lotes que ha revocado
  publishedPayslipItems    PayslipUploadItem[] @relation("ItemPublisher") // Items que ha publicado
  revokedPayslipItems      PayslipUploadItem[] @relation("ItemRevoker") // Items que ha revocado
  revokedEmployeeDocuments EmployeeDocument[]  @relation("DocumentRevoker") // Documentos que ha revocado
  deletedEmployeeDocuments EmployeeDocument[]  @relation("DocumentDeleter") // Documentos que ha eliminado (soft delete)
  deletedStoredFiles       StoredFile[]        @relation("StoredFileDeletedBy") // Archivos cuya eliminaci√≥n ha solicitado

  // Sistema de permisos y alertas
  areaResponsibilities AreaResponsible[]         @relation("UserAreaResponsibilities") // √Åreas de las que es responsable
  alertSubscriptions   AlertSubscription[]       @relation("UserAlertSubscriptions") // Suscripciones a alertas
  resolvedAlerts       Alert[]                   @relation("AlertResolver") // Alertas que ha resuelto
  alertAssignments     AlertAssignment[]         @relation("AlertAssignmentUser") // Alertas asignadas
  alertAssignmentsMade AlertAssignment[]         @relation("AlertAssignmentAssignedBy") // Asignaciones creadas
  alertNotes           AlertNote[]               @relation("AlertNoteAuthor") // Notas internas en alertas
  activeContext        UserActiveContext? // Contexto activo seleccionado por el usuario
  procedureHistory     ExpenseProcedureHistory[] // Historial de expedientes donde ha actuado

  // NUEVO: Sistema de firma masiva (Mejora 7)
  createdSignatureBatches SignatureBatch[] @relation("CreatedBatches") // Lotes de firma que ha creado
  secondSignerBatches     SignatureBatch[] @relation("SecondSignerBatches") // Lotes donde es segundo firmante espec√≠fico

  // NUEVO: Canal de Denuncias (Ley 2/2023)
  assignedWhistleblowingReports WhistleblowingReport[]   @relation("WhistleblowingAssignee") // Denuncias asignadas
  resolvedWhistleblowingReports WhistleblowingReport[]   @relation("WhistleblowingResolver") // Denuncias resueltas
  closedWhistleblowingReports   WhistleblowingReport[]   @relation("WhistleblowingCloser") // Denuncias cerradas
  uploadedWhistleblowingDocs    WhistleblowingDocument[] // Documentos de denuncias que ha subido
  whistleblowingActivities      WhistleblowingActivity[] // Actividades de denuncias que ha realizado

  // NUEVO: Tokens de autenticaci√≥n (invitaciones, reset password)
  authTokens AuthToken[]

  // Historial de contrase√±as (seguridad - evitar reutilizaci√≥n)
  passwordHistory PasswordHistory[]

  // Jobs de alta guiada de organizaciones
  organizationSetupJobs OrganizationSetupJob[]

  @@index([email])
  @@index([orgId])
  @@map("users")
}

model UserOrganization {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  orgId  String

  role                       Role    @default(EMPLOYEE)
  isDefault                  Boolean @default(false)
  isActive                   Boolean @default(true)
  canManageUserOrganizations Boolean @default(false)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([userId])
  @@index([orgId])
  @@map("user_organizations")
}

// Sesiones para NextAuth
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// Historial de contrase√±as (seguridad - evitar reutilizaci√≥n de √∫ltimas N contrase√±as)
model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String // Hash de contrase√±a anterior
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // √çndice compuesto para queries eficientes
  @@map("password_history")
}

// Tipos de token de autenticaci√≥n
enum AuthTokenType {
  INVITE // Alta de usuario (aceptar invitaci√≥n / crear contrase√±a)
  RESET_PASSWORD // Recuperar contrase√±a
}

// Tokens de autenticaci√≥n (invitaciones, reset password)
model AuthToken {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      AuthTokenType
  token     String        @unique // Token p√∫blico
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId, type])
  @@index([token])
  @@map("auth_tokens")
}

// Tipos de jerarqu√≠a organizacional
enum HierarchyType {
  FLAT // Sin jerarqu√≠a (todos al mismo nivel, organizaciones planas)
  DEPARTMENTAL // Por departamentos (managers de depto + empleados)
  HIERARCHICAL // Jer√°rquico completo (CEO ‚Üí directores ‚Üí managers ‚Üí empleados)
}

// Roles b√°sicos del sistema
enum Role {
  SUPER_ADMIN // Super administrador (multi-org)
  ORG_ADMIN // Administrador de organizaci√≥n
  HR_ADMIN // RRHH
  HR_ASSISTANT // Asistente de RRHH (operativo sin datos sensibles)
  MANAGER // Manager/Supervisor
  EMPLOYEE // Empleado b√°sico
}

// Modos de gesti√≥n de gastos
enum ExpenseMode {
  PRIVATE // Flujo cl√°sico: Gasto -> Aprobaci√≥n -> Reembolso
  PUBLIC // Flujo p√∫blico: Expediente -> Autorizaci√≥n -> Gasto -> Justificaci√≥n
  MIXED // Ambos permitidos
}

// ==================== SPRINT 1: MODELOS DE RRHH ====================

// Centro de coste - Ubicaciones f√≠sicas donde trabajar
model CostCenter {
  id          String   @id @default(cuid())
  name        String
  code        String? // C√≥digo interno del centro
  description String? // Descripci√≥n del centro
  address     String?
  timezone    String   @default("Europe/Madrid")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Geolocalizaci√≥n (opcional - para validar fichajes)
  latitude            Decimal? @db.Decimal(10, 8) // Latitud del centro de trabajo
  longitude           Decimal? @db.Decimal(11, 8) // Longitud del centro de trabajo
  allowedRadiusMeters Int?     @default(100) // Radio permitido en metros para fichar

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  departments         Department[]
  employmentContracts EmploymentContract[]
  calendars           Calendar[]
  timeClockTerminals  TimeClockTerminal[]
  expenses            Expense[]
  exceptionOverrides  ExceptionDayOverride[] // Excepciones por centro de costes
  manualAssignments   ManualShiftAssignment[] // Asignaciones manuales en este centro
  workZones           WorkZone[] // Zonas de trabajo del centro

  // Sistema de permisos y alertas
  areaResponsibles   AreaResponsible[]   @relation("CostCenterResponsibles") // Responsables de este centro
  alertSubscriptions AlertSubscription[] @relation("CostCenterAlertSubscriptions") // Suscripciones a alertas de este centro
  alerts             Alert[]             @relation("AlertCostCenter") // Alertas del centro (actuales)
  originalAlerts     Alert[]             @relation("AlertOriginalCostCenter") // Alertas hist√≥ricas generadas cuando el empleado estaba aqu√≠

  // NUEVO: Equipos del centro
  teams Team[]

  // NUEVO: Contextos activos con este centro
  activeContexts UserActiveContext[] @relation("UserActiveCostCenter")

  @@index([orgId])
  @@map("cost_centers")
}

// Departamento - Divisi√≥n organizativa
model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaci√≥n con centro de coste
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Responsable del departamento
  managerId String?
  manager   Employee? @relation("DepartmentManager", fields: [managerId], references: [id])

  // Relaciones
  employmentContracts EmploymentContract[]
  exceptionOverrides  ExceptionDayOverride[] // Excepciones por departamento

  // Relaciones inversas (a√±adidas para sistema de alertas y permisos v2.0)
  teams              Team[]              @relation("DepartmentTeams") // Equipos del departamento
  areaResponsibles   AreaResponsible[]   @relation("DepartmentResponsibles") // Responsables del departamento
  alertSubscriptions AlertSubscription[] @relation("DepartmentAlertSubscriptions") // Suscripciones a alertas
  alerts             Alert[]             @relation("DepartmentAlerts") // Alertas del departamento
  activeContexts     UserActiveContext[] @relation("UserActiveDepartment") // Contextos activos con este departamento

  @@index([orgId])
  @@index([managerId])
  @@map("departments")
}

// Nivel de puesto - Jerarqu√≠a organizacional
model PositionLevel {
  id          String  @id @default(cuid())
  name        String // "Junior", "Mid", "Senior", "Lead", "Principal"
  code        String? // C√≥digo interno opcional (ej: "L1", "L2", "L3")
  order       Int     @default(0) // Orden jer√°rquico (1=m√°s bajo, 10=m√°s alto)
  description String? // Descripci√≥n del nivel

  // Rangos salariales opcionales
  minSalary Decimal? @db.Decimal(10, 2)
  maxSalary Decimal? @db.Decimal(10, 2)

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  positions Position[]

  @@unique([orgId, name]) // No duplicar niveles en la misma organizaci√≥n
  @@unique([orgId, order]) // No duplicar orden en la misma organizaci√≥n
  @@index([orgId])
  @@index([order])
  @@map("position_levels")
}

// Posici√≥n/Puesto de trabajo
model Position {
  id          String   @id @default(cuid())
  title       String // T√≠tulo del puesto
  description String? // Descripci√≥n del puesto
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaci√≥n con nivel jer√°rquico
  levelId String?
  level   PositionLevel? @relation(fields: [levelId], references: [id])

  // Relaciones
  employmentContracts EmploymentContract[]

  @@index([orgId])
  @@index([levelId])
  @@map("positions")
}

// Empleado - Datos personales y perfil del empleado
model Employee {
  id                           String         @id @default(cuid())
  employeeNumber               String? // N√∫mero de empleado √∫nico en la org
  requiresEmployeeNumberReview Boolean        @default(false) // Flag: N√∫mero de empleado requiere revisi√≥n manual
  firstName                    String
  lastName                     String
  secondLastName               String?
  nifNie                       String // NIF/NIE
  email                        String?
  phone                        String?
  mobilePhone                  String?
  address                      String?
  city                         String?
  postalCode                   String?
  province                     String?
  country                      String         @default("ES")
  birthDate                    DateTime?
  nationality                  String?
  gender                       EmployeeGender @default(NOT_SPECIFIED)

  // Datos bancarios (cifrados)
  iban                         String? // Se cifrar√° a nivel de aplicaci√≥n
  preferredReimbursementMethod ReimbursementMethod? // M√©todo preferido para reembolsos

  // Contacto de emergencia
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyRelationship String?

  // Estado laboral
  employmentStatus EmploymentStatus @default(PENDING_CONTRACT)

  // Metadatos
  photoUrl         String?
  notes            String?
  additionalFields Json     @default("[]") // Campos adicionales configurables por empresa
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaci√≥n opcional con usuario del sistema
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Relaciones
  employmentContracts     EmploymentContract[]
  documents               EmployeeDocument[]
  storedFiles             StoredFile[]
  managedContracts        EmploymentContract[]     @relation("ManagerSubordinates")
  managedDepartments      Department[]             @relation("DepartmentManager")
  timeEntries             TimeEntry[]
  workdaySummaries        WorkdaySummary[]
  ptoBalances             PtoBalance[]
  ptoRequests             PtoRequest[]
  recurringPtoAdjustments RecurringPtoAdjustment[]
  signers                 Signer[]
  manualTimeEntryRequests ManualTimeEntryRequest[]
  timeBankMovements       TimeBankMovement[]
  timeBankRequests        TimeBankRequest[]
  overworkAuthorizations  OverworkAuthorization[]
  expenses                Expense[]
  expenseProcedures       ExpenseProcedure[]
  expenseReports          ExpenseReport[]

  // Aprobador espec√≠fico de gastos para este empleado (opcional, sobrescribe org)
  expenseApproverId String?
  expenseApprover   User?   @relation("EmployeeExpenseApprover", fields: [expenseApproverId], references: [id], onDelete: SetNull)

  // NUEVAS relaciones para Sistema de Horarios V2.0
  scheduleAssignments EmployeeScheduleAssignment[]
  manualAssignments   ManualShiftAssignment[]
  exceptionDays       ExceptionDayOverride[]

  // Sistema de permisos y alertas
  alerts Alert[] @relation("EmployeeAlerts") // Alertas generadas para este empleado

  // NUEVO: Equipo al que pertenece (opcional)
  teamId String?
  team   Team?   @relation("EmployeeTeam", fields: [teamId], references: [id])

  // Sistema de proyectos (Mejora 4)
  projectAssignments ProjectAssignment[]

  // NUEVO: Liquidaciones de vacaciones (Mejora 1)
  vacationSettlements VacationSettlement[]

  // NUEVO: N√≥minas asignadas (Mejora 3)
  payslipUploadItems PayslipUploadItem[] // Items de n√≥minas asignados a este empleado

  // NUEVO: Canal de Denuncias (Ley 2/2023)
  whistleblowingReports WhistleblowingReport[] // Denuncias presentadas como empleado autenticado
  OvertimeCandidate     OvertimeCandidate[]

  @@unique([orgId, employeeNumber]) // N√∫mero √∫nico por organizaci√≥n
  @@unique([orgId, nifNie]) // NIF √∫nico por organizaci√≥n
  @@index([orgId])
  @@index([email])
  @@index([expenseApproverId])
  @@index([teamId])
  @@map("employees")
}

// =====================================================
// ENUMS PARA SISTEMA DE LIQUIDACI√ìN Y FIJOS DISCONTINUOS
// =====================================================

// Tipo de contrato - Valores v√°lidos (validar en aplicaci√≥n):
// INDEFINIDO, TEMPORAL, PRACTICAS, FORMACION, OBRA_SERVICIO, EVENTUAL, INTERINIDAD, FIJO_DISCONTINUO
// NOTA: Se mantiene como String para evitar p√©rdida de datos en migraci√≥n.
// La validaci√≥n de valores se hace a nivel de aplicaci√≥n.

// Estado de contrato fijo discontinuo
enum DiscontinuousStatus {
  ACTIVE
  PAUSED
}

// Estado de liquidaci√≥n de vacaciones
enum SettlementStatus {
  PENDING
  PAID
  COMPENSATED
}

// Contrato laboral - Datos contractuales del empleado
model EmploymentContract {
  id                 String    @id @default(cuid())
  contractType       String // INDEFINIDO, TEMPORAL, PRACTICAS, FORMACION, OBRA_SERVICIO, EVENTUAL, INTERINIDAD, FIJO_DISCONTINUO
  startDate          DateTime
  endDate            DateTime? // null para indefinidos
  weeklyHours        Decimal   @db.Decimal(5, 2) // Horas semanales pactadas
  workingDaysPerWeek Decimal?  @default(5) @db.Decimal(3, 1) // D√≠as laborables por semana (4, 5, 6, etc.)
  grossSalary        Decimal?  @db.Decimal(10, 2) // Salario bruto anual

  // üÜï SISTEMA DE BALANCE EN MINUTOS - Minutos por jornada laboral
  workdayMinutes Int? // Jornada est√°ndar en minutos (null = calcular autom√°tico: weeklyHours / workingDaysPerWeek * 60)

  // Tipo de horario contractual (NUEVO: Para distinguir l√≥gica de fichajes)
  workScheduleType ScheduleAssignmentType @default(FIXED)

  // NOTA: Los horarios ahora se gestionan en el nuevo Sistema de Horarios V2.0
  // Ver modelos: ScheduleTemplate, SchedulePeriod, WorkDayPattern, TimeSlot, EmployeeScheduleAssignment

  // =====================================================
  // SISTEMA DE FIJOS DISCONTINUOS (Mejora 1)
  // =====================================================
  // Estado del contrato para fijos discontinuos (null para otros tipos)
  discontinuousStatus DiscontinuousStatus?
  // Historial de pausas/reanudaciones
  pauseHistory        ContractPauseHistory[]

  // Metadatos
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  positionId String?
  position   Position? @relation(fields: [positionId], references: [id])

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Responsable/Manager
  managerId String?
  manager   Employee? @relation("ManagerSubordinates", fields: [managerId], references: [id])

  @@index([orgId])
  @@index([employeeId])
  @@map("employment_contracts")
}

// =====================================================
// HISTORIAL DE PAUSAS DE CONTRATOS FIJOS DISCONTINUOS
// =====================================================
model ContractPauseHistory {
  id         String             @id @default(cuid())
  contractId String
  contract   EmploymentContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  action    String // "PAUSE" | "RESUME"
  startDate DateTime // Fecha inicio del per√≠odo de pausa
  endDate   DateTime? // Fecha fin (null si a√∫n pausado)
  reason    String? // Motivo de la pausa

  // Auditor√≠a
  performedBy String // userId que realiz√≥ la acci√≥n
  performedAt DateTime @default(now())

  @@index([contractId])
  @@map("contract_pause_history")
}

// =====================================================
// LIQUIDACI√ìN DE VACACIONES (Mejora 1)
// =====================================================
model VacationSettlement {
  id           String       @id @default(cuid())
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  contractId   String? // Puede ser null si contrato ya eliminado

  settlementDate DateTime // Fecha de corte/liquidaci√≥n

  // C√°lculos en D√çAS (para display)
  accruedDays Decimal @db.Decimal(5, 2) // D√≠as devengados
  usedDays    Decimal @db.Decimal(5, 2) // D√≠as disfrutados
  pendingDays Decimal @db.Decimal(5, 2) // D√≠as en solicitudes pendientes
  balanceDays Decimal @db.Decimal(5, 2) // Saldo final = accrued - used - pending

  // C√°lculos en MINUTOS (coherencia con sistema PTO)
  accruedMinutes Int @default(0)
  usedMinutes    Int @default(0)
  pendingMinutes Int @default(0)
  balanceMinutes Int @default(0)

  // Jornada usada para conversi√≥n d√≠as <-> minutos
  workdayMinutes Int @default(480)

  // Estado de la liquidaci√≥n
  status SettlementStatus @default(PENDING)
  notes  String?

  // Auto-generada al finalizar contrato
  isAutoGenerated Boolean @default(false)

  // Auditor√≠a
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([employeeId])
  @@map("vacation_settlements")
}

// Documentos del empleado
model EmployeeDocument {
  id          String       @id @default(cuid())
  kind        DocumentKind // Tipo de documento
  fileName    String // Nombre original del archivo
  storageUrl  String // URL en Azure Blob o almac√©n
  fileSize    Int // Tama√±o en bytes
  mimeType    String // Tipo MIME
  version     Int          @default(1) // Versi√≥n del documento
  description String? // Descripci√≥n opcional
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Ledger de almacenamiento
  storedFileId String?
  storedFile   StoredFile? @relation(fields: [storedFileId], references: [id], onDelete: SetNull)

  // Campos espec√≠ficos para n√≥minas (kind = PAYSLIP) - Mejora 3
  payslipMonth Int? // Mes de la n√≥mina (1-12)
  payslipYear  Int? // A√±o de la n√≥mina

  // Trazabilidad con lote de subida masiva - Mejora 3
  payslipBatchId String?
  payslipBatch   PayslipBatch? @relation("PayslipBatchDocuments", fields: [payslipBatchId], references: [id])

  // Relaci√≥n inversa con item de n√≥mina - Mejora 3
  payslipUploadItem PayslipUploadItem?

  // Revocaci√≥n (fortalecido - para quitar acceso inmediato)
  isRevoked    Boolean   @default(false) // Si el documento fue revocado
  revokedAt    DateTime? // Cu√°ndo se revoc√≥
  revokedById  String? // Usuario que revoc√≥
  revokedBy    User?     @relation("DocumentRevoker", fields: [revokedById], references: [id])
  revokeReason String? // Motivo de revocaci√≥n

  // Soft delete (Papelera Legal)
  deletedAt   DateTime? // Fecha de eliminaci√≥n (soft delete)
  deletedById String? // Usuario que elimin√≥
  deletedBy   User?     @relation("DocumentDeleter", fields: [deletedById], references: [id])

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Usuario que subi√≥ el documento
  uploadedById String
  uploadedBy   User   @relation("DocumentUploader", fields: [uploadedById], references: [id])

  @@index([orgId])
  @@index([employeeId])
  @@index([kind, payslipYear, payslipMonth])
  @@index([isRevoked])
  @@index([storedFileId])
  @@index([deletedAt]) // Para filtrar papelera
  @@map("employee_documents")
}

// =============================================
// SISTEMA CENTRALIZADO DE STORAGE Y RETENCI√ìN
// =============================================
model StoredFile {
  id String @id @default(cuid())

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  path      String
  sizeBytes Int
  mimeType  String

  category        FileCategory
  retentionPolicy RetentionPolicy

  retainUntil     DateTime?
  legalHold       Boolean   @default(false)
  legalHoldReason String?

  createdAt   DateTime  @default(now())
  deletedAt   DateTime?
  deletedById String?
  deletedBy   User?     @relation("StoredFileDeletedBy", fields: [deletedById], references: [id])

  employeeDocuments       EmployeeDocument[]
  ptoRequestDocuments     PtoRequestDocument[]
  expenseAttachments      ExpenseAttachment[]
  whistleblowingDocuments WhistleblowingDocument[]
  signableDocuments       SignableDocument[]

  @@index([orgId])
  @@index([retainUntil])
  @@map("stored_files")
}

// =============================================
// SISTEMA DE N√ìMINAS MASIVAS (Mejora 3)
// =============================================

// Lote de subida de n√≥minas
model PayslipBatch {
  id String @id @default(cuid())

  // Tipo de lote (masivo vs individual)
  kind PayslipBatchKind @default(BULK_UPLOAD)

  // Periodo de las n√≥minas
  month       Int? // 1-12 (opcional si se usa periodo)
  year        Int? // 2024, 2025...
  periodStart DateTime? // Opcional para periodos no mensuales
  periodEnd   DateTime? // Opcional para periodos no mensuales
  label       String? // Etiqueta opcional (ej: "Paga extra verano")

  // Archivos originales
  originalFileName String // nombre.zip o nominas.pdf
  originalFileType String // "ZIP" | "PDF_MULTIPAGE" | "SINGLE_PDF"

  // Estad√≠sticas del procesamiento (fortalecido)
  totalFiles      Int @default(0)
  assignedCount   Int @default(0) // Items con empleado asignado (READY o PUBLISHED)
  pendingCount    Int @default(0) // Items pendientes de revisi√≥n
  errorCount      Int @default(0) // Items con error
  readyCount      Int @default(0) // Items listos para publicar
  blockedInactive Int @default(0) // Bloqueados por empleado inactivo
  publishedCount  Int @default(0) // Items ya publicados
  revokedCount    Int @default(0) // Items revocados

  // Estado del lote
  status PayslipBatchStatus @default(PROCESSING)

  // Auditor√≠a de creaci√≥n
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Publicaci√≥n expl√≠cita
  publishedAt   DateTime? // Cu√°ndo se public√≥ el lote
  publishedById String? // Usuario que public√≥
  publishedBy   User?     @relation("BatchPublisher", fields: [publishedById], references: [id])

  // Revocaci√≥n del lote
  revokedAt    DateTime? // Cu√°ndo se revoc√≥
  revokedById  String? // Usuario que revoc√≥
  revokedBy    User?     @relation("BatchRevoker", fields: [revokedById], references: [id])
  revokeReason String? // Motivo de revocaci√≥n

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Usuario que subi√≥
  uploadedById String
  uploadedBy   User   @relation("BatchUploader", fields: [uploadedById], references: [id])

  // Items del lote
  items PayslipUploadItem[]

  // Documentos generados
  documents EmployeeDocument[]  @relation("PayslipBatchDocuments")
  events    PayslipBatchEvent[]

  @@index([orgId])
  @@index([year, month])
  @@index([status])
  @@index([kind])
  @@map("payslip_batches")
}

model PayslipBatchEvent {
  id        String       @id @default(cuid())
  batchId   String
  batch     PayslipBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  type      String
  message   String
  meta      Json?
  createdAt DateTime     @default(now())

  @@index([batchId])
  @@index([createdAt])
  @@map("payslip_batch_events")
}

// Item individual de n√≥mina (cada PDF extra√≠do)
model PayslipUploadItem {
  id String @id @default(cuid())

  // Referencia al lote
  batchId String
  batch   PayslipBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // Archivo temporal
  tempFilePath     String // Ruta temporal del PDF individual
  originalFileName String? // Nombre original del archivo (para extraer DNI)
  pageNumber       Int? // Si viene de PDF multip√°gina

  // Detecci√≥n autom√°tica (OCR o regex en nombre de archivo)
  detectedDni     String?
  detectedName    String?
  detectedCode    String?
  confidenceScore Float   @default(0) // 0-1

  // Estado y errores
  status       PayslipItemStatus @default(PENDING_OCR)
  errorMessage String? // Para registrar fallos de OCR o matching

  // Auto-asignaci√≥n (fortalecido)
  isAutoMatched Boolean @default(false) // Si el match fue autom√°tico (confianza >= 0.9)

  // Empleado asignado
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Documento final creado
  documentId String?           @unique
  document   EmployeeDocument? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  // Auditor√≠a de creaci√≥n/asignaci√≥n
  createdAt    DateTime  @default(now())
  assignedAt   DateTime?
  assignedById String? // Usuario que asign√≥ (null si autom√°tico)

  // Publicaci√≥n expl√≠cita (fortalecido)
  publishedAt   DateTime? // Cu√°ndo se public√≥ este item
  publishedById String? // Usuario que public√≥
  publishedBy   User?     @relation("ItemPublisher", fields: [publishedById], references: [id])

  // Revocaci√≥n (fortalecido)
  revokedAt    DateTime? // Cu√°ndo se revoc√≥
  revokedById  String? // Usuario que revoc√≥
  revokedBy    User?     @relation("ItemRevoker", fields: [revokedById], references: [id])
  revokeReason String? // Motivo de revocaci√≥n

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([orgId])
  @@index([status])
  @@map("payslip_upload_items")
}

// Tipos de documentos
enum DocumentKind {
  CONTRACT // Contrato laboral
  PAYSLIP // N√≥mina
  ID_DOCUMENT // DNI/NIE
  SS_DOCUMENT // Documento Seguridad Social
  CERTIFICATE // Certificados (idiomas, formaci√≥n, etc.)
  MEDICAL // Documentos m√©dicos
  OTHER // Otros documentos
}

// Categor√≠as funcionales de archivos
enum FileCategory {
  PAYROLL
  CONTRACT
  TIME_TRACKING
  PTO
  WHISTLEBLOWING
  SIGNATURE
  EXPENSE
  OTHER
}

// Pol√≠ticas legales de retenci√≥n (pueden coincidir en nombre con categor√≠as, pero tienen sem√°ntica legal)
enum RetentionPolicy {
  PAYROLL
  CONTRACT
  TIME_TRACKING
  PTO
  WHISTLEBLOWING
  SIGNATURE
  GENERIC
}

// Estados del lote de n√≥minas (Mejora 3 - Fortalecido)
enum PayslipBatchStatus {
  PROCESSING // En proceso de extracci√≥n/OCR
  REVIEW // Pendiente de revisi√≥n manual
  READY_TO_PUBLISH // Listo para publicar (nuevo)
  COMPLETED // Todas las n√≥minas publicadas
  PARTIAL // Parcialmente completado
  ERROR // Error en procesamiento
  CANCELLED // Lote cancelado/revocado (nuevo)
}

// Estados del item individual de n√≥mina (Mejora 3 - Fortalecido)
enum PayslipItemStatus {
  PENDING_OCR // Reci√©n importado, en cola para OCR
  PENDING_REVIEW // Requiere revisi√≥n humana (baja confianza o m√∫ltiples candidatos)
  READY // Listo para publicar (match seguro, esperando confirmaci√≥n)
  PUBLISHED // Visible para el empleado
  BLOCKED_INACTIVE // Match a empleado inactivo
  ERROR // Error en procesamiento
  REVOKED // Publicado y luego revocado
  SKIPPED // Saltado/descartado manualmente
}

// Tipo de lote de n√≥minas (subida masiva vs individual)
enum PayslipBatchKind {
  BULK_UPLOAD // Lote masivo (ZIP o PDF multip√°gina)
  MANUAL_SINGLE // Subida individual de n√≥mina
}

// Estados laborales del empleado
enum EmploymentStatus {
  PENDING_CONTRACT // Pendiente de contrato
  ACTIVE // Activo trabajando
  ON_LEAVE // De baja/permiso
  VACATION // Vacaciones
  SUSPENDED // Suspendido
  TERMINATED // Dado de baja
  RETIRED // Jubilado
}

// G√©nero del empleado
enum EmployeeGender {
  MALE
  FEMALE
  NON_BINARY
  NOT_SPECIFIED
}

// NOTA: ScheduleType enum eliminado - Ahora se usa Sistema de Horarios V2.0
// Ver enums: ScheduleTemplateType, SchedulePeriodType, TimeSlotType, PresenceType

// ==================== SISTEMA DE CONTRASE√ëAS TEMPORALES ====================

// Contrase√±as temporales generadas para usuarios
model TemporaryPassword {
  id                String    @id @default(cuid())
  password          String // Contrase√±a encriptada
  createdAt         DateTime  @default(now())
  usedAt            DateTime? // Cuando fue usada por primera vez
  expiresAt         DateTime // Cu√°ndo expira
  active            Boolean   @default(true)
  invalidatedAt     DateTime?
  invalidatedReason String?

  // Notas administrativas
  reason String? // Raz√≥n de la generaci√≥n (ej: "Nuevo empleado", "Reset solicitado")
  notes  String? // Notas adicionales del administrador

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Usuario al que pertenece la contrase√±a
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Usuario que cre√≥ la contrase√±a temporal (admin/HR)
  createdById String
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])

  @@index([userId])
  @@index([orgId])
  @@index([active])
  @@index([expiresAt])
  @@map("temporary_passwords")
}

// Tokens de suplantaci√≥n para soporte (SUPER_ADMIN)
model SupportImpersonationToken {
  id             String    @id @default(cuid())
  tokenHash      String    @unique
  createdAt      DateTime  @default(now())
  expiresAt      DateTime
  usedAt         DateTime?
  sessionMinutes Int       @default(60)
  reason         String

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Usuario objetivo
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // SUPER_ADMIN que gener√≥ el token
  createdById String
  createdBy   User   @relation("SupportImpersonationCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([orgId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("support_impersonation_tokens")
}

// ==================== SISTEMA DE CALENDARIOS ====================

// Calendario organizacional (festivos, eventos corporativos)
model Calendar {
  id           String       @id @default(cuid())
  name         String // "Festivos Nacionales 2024", "Festivos Barcelona 2024"
  description  String?
  year         Int // A√±o al que aplica
  calendarType CalendarType @default(NATIONAL_HOLIDAY)
  color        String       @default("#3b82f6") // Color hex para identificaci√≥n visual
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaci√≥n opcional con centro de coste (para calendarios locales)
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Relaciones
  events CalendarEvent[]

  @@index([orgId])
  @@index([costCenterId])
  @@index([year])
  @@map("calendars")
}

// Eventos del calendario (festivos, cierres, eventos)
model CalendarEvent {
  id          String            @id @default(cuid())
  name        String // "D√≠a de Reyes", "Cierre de verano"
  description String?
  date        DateTime // Fecha del evento
  endDate     DateTime? // Para eventos de varios d√≠as
  eventType   CalendarEventType @default(HOLIDAY)
  isRecurring Boolean           @default(false) // Si se repite cada a√±o
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relaci√≥n con calendario
  calendarId String
  calendar   Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId])
  @@index([date])
  @@map("calendar_events")
}

// Tipos de calendario
enum CalendarType {
  NATIONAL_HOLIDAY // Festivos nacionales
  LOCAL_HOLIDAY // Festivos locales por centro
  CORPORATE_EVENT // Eventos corporativos
  CUSTOM // Personalizado
}

// Tipos de eventos
enum CalendarEventType {
  HOLIDAY // Festivo
  CLOSURE // Cierre (oficina cerrada)
  EVENT // Evento corporativo
  MEETING // Reuni√≥n importante
  DEADLINE // Fecha l√≠mite
  OTHER // Otro
}

// ==================== SPRINT 2: SISTEMA DE FICHAJES ====================

// Terminal de fichaje (opcional - para fichaje desde terminales f√≠sicos)
model TimeClockTerminal {
  id        String   @id @default(cuid())
  name      String // "Terminal Recepci√≥n", "Terminal F√°brica"
  code      String // C√≥digo √∫nico del terminal
  location  String? // Ubicaci√≥n f√≠sica
  ipAddress String? // IP del terminal
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaci√≥n opcional con centro de coste
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Relaciones
  timeEntries TimeEntry[]

  @@unique([orgId, code])
  @@index([orgId])
  @@index([costCenterId])
  @@map("time_clock_terminals")
}

// Registro individual de fichaje (entrada, salida, pausa)
model TimeEntry {
  id        String        @id @default(cuid())
  entryType TimeEntryType // CLOCK_IN, CLOCK_OUT, BREAK_START, BREAK_END
  timestamp DateTime      @default(now()) // Momento exacto del fichaje
  location  String? // Geolocalizaci√≥n o ubicaci√≥n (texto legible, deprecated)
  notes     String? // Notas opcionales
  ipAddress String? // IP desde donde se fich√≥
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Geolocalizaci√≥n estructurada (campos nuevos)
  latitude            Decimal? @db.Decimal(10, 8) // Latitud del fichaje
  longitude           Decimal? @db.Decimal(11, 8) // Longitud del fichaje
  accuracy            Decimal? @db.Decimal(10, 2) // Precisi√≥n GPS en metros
  isWithinAllowedArea Boolean? // Si est√° dentro del √°rea permitida del centro
  distanceFromCenter  Decimal? @db.Decimal(10, 2) // Distancia al centro m√°s cercano en metros
  nearestCostCenterId String? // ID del centro de trabajo m√°s cercano
  requiresReview      Boolean  @default(false) // Si requiere revisi√≥n por estar fuera de √°rea

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado que ficha
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Terminal desde el que se fich√≥ (opcional)
  terminalId String?
  terminal   TimeClockTerminal? @relation(fields: [terminalId], references: [id])

  // Relaci√≥n con el resumen del d√≠a
  workdayId String?
  workday   WorkdaySummary? @relation(fields: [workdayId], references: [id])

  // Fichaje manual (si fue creado desde una solicitud aprobada)
  isManual        Boolean @default(false)
  manualRequestId String? // ID de la solicitud que lo cre√≥

  // Validaci√≥n contra horario (Schedule V2.0)
  validationWarnings String[] @default([]) // Warnings de validaci√≥n (ej: "Fichaje tard√≠o: 20 minutos")
  validationErrors   String[] @default([]) // Errores de validaci√≥n (ej: "D√≠a no laboral")
  deviationMinutes   Int? // Desviaci√≥n en minutos respecto al horario esperado (+/-)

  // Cancelaci√≥n y auditor√≠a de fichajes
  isCancelled           Boolean             @default(false) // Si este fichaje fue cancelado
  cancellationReason    CancellationReason? // Motivo de la cancelaci√≥n
  cancelledAt           DateTime? // Fecha/hora de cancelaci√≥n
  originalDurationHours Decimal?            @db.Decimal(6, 2) // Duraci√≥n original si fue cancelado por larga duraci√≥n
  cancellationNotes     String? // Notas adicionales sobre la cancelaci√≥n

  // Sistema de permisos y alertas
  alerts Alert[] @relation("TimeEntryAlerts") // Alertas generadas por este fichaje

  // Pausas Autom√°ticas (Mejora 6) - Campos para tracking de pausas autom√°ticas
  isAutomatic          Boolean @default(false) // Si este fichaje fue generado autom√°ticamente
  automaticBreakSlotId String? // ID del TimeSlot BREAK que origin√≥ esta pausa (idempotencia)
  automaticBreakNotes  String? // Descripci√≥n de la regla aplicada: "Pausa autom√°tica 13:00-13:30 (Oficina Central)"

  // Proyectos (Mejora 4) - Imputaci√≥n a proyectos
  // REGLA: Solo en entradas de trabajo (CLOCK_IN), NO en BREAK
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
  task      String?  @db.VarChar(255) // Tarea/descripci√≥n corta

  @@index([orgId])
  @@index([projectId])
  @@index([employeeId])
  @@index([timestamp])
  @@index([entryType])
  @@index([workdayId])
  @@index([isCancelled])
  // √çndices compuestos para consultas frecuentes (FASE 4 - Robustez)
  @@index([employeeId, orgId, timestamp])
  @@index([employeeId, orgId, entryType, timestamp])
  @@index([employeeId, orgId, isCancelled, timestamp])
  @@map("time_entries")
}

// Resumen consolidado de un d√≠a laboral
model WorkdaySummary {
  id                    String             @id @default(cuid())
  date                  DateTime // Fecha del d√≠a (sin hora)
  clockIn               DateTime? // Primera entrada del d√≠a
  clockOut              DateTime? // √öltima salida del d√≠a
  totalWorkedMinutes    Decimal            @default(0) @db.Decimal(10, 2) // Minutos trabajados totales (con decimales para segundos)
  totalBreakMinutes     Decimal            @default(0) @db.Decimal(10, 2) // Minutos de pausa totales (con decimales para segundos)
  status                WorkdayStatus      @default(IN_PROGRESS) // IN_PROGRESS, COMPLETED, INCOMPLETE
  notes                 String? // Notas administrativas
  excessiveTimeNotified Boolean            @default(false) // Si se notific√≥ fichaje excesivo (> 150% jornada)
  overtimeCalcStatus    OvertimeCalcStatus @default(DIRTY)
  overtimeCalcUpdatedAt DateTime?

  // NUEVOS campos para Sistema de Horarios V2.0
  expectedMinutes  Decimal? @db.Decimal(6, 2) // Minutos esperados seg√∫n horario asignado
  deviationMinutes Decimal? @db.Decimal(6, 2) // Desviaci√≥n (real - esperado)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Relaciones
  timeEntries TimeEntry[]

  // Sistema de permisos y alertas
  alerts            Alert[]            @relation("WorkdayAlerts") // Alertas generadas por este d√≠a laboral
  timeBankMovements TimeBankMovement[]
  overtimeCandidate OvertimeCandidate? @relation("WorkdayOvertimeCandidate")

  @@unique([orgId, employeeId, date]) // Un resumen por empleado por d√≠a
  @@index([orgId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  // √çndices compuestos para reportes (FASE 3 - Organizaci√≥n)
  @@index([employeeId, date]) // Reportes mensuales/semanales por empleado
  @@index([orgId, date]) // Reportes globales de un d√≠a
  @@index([orgId, employeeId, status]) // Reportes de incidencias por empleado
  @@map("workday_summaries")
}

// Tipos de fichaje
enum TimeEntryType {
  CLOCK_IN // Entrada
  CLOCK_OUT // Salida
  BREAK_START // Inicio de pausa
  BREAK_END // Fin de pausa
  PROJECT_SWITCH // Cambio de proyecto durante la jornada (no altera estado)
}

// Estados del d√≠a laboral
enum WorkdayStatus {
  IN_PROGRESS // D√≠a en curso (a√∫n no ha fichado salida)
  COMPLETED // D√≠a completado correctamente
  INCOMPLETE // D√≠a incompleto (falta salida o hay inconsistencias)
  ABSENT // Ausente (no fich√≥)
}

// Motivos de cancelaci√≥n de fichajes
enum CancellationReason {
  EXCESSIVE_DURATION // Fichaje de larga duraci√≥n (> 150% jornada laboral)
  USER_ERROR // Error del usuario al fichar
  SYSTEM_ERROR // Error t√©cnico del sistema
  ADMIN_CORRECTION // Correcci√≥n administrativa
  REPLACED_BY_MANUAL_REQUEST // Reemplazado por solicitud manual aprobada
}

// ==================== SISTEMA DE BOLSA DE HORAS ====================

model TimeBankSettings {
  id                                  String                      @id @default(cuid())
  orgId                               String                      @unique
  maxPositiveMinutes                  Int                         @default(4800) // L√≠mite recomendado 80h
  maxNegativeMinutes                  Int                         @default(480) // L√≠mite de d√©ficit (minutos absolutos)
  dailyExcessLimitMinutes             Int                         @default(120) // Exceso m√°ximo diario sin revisi√≥n
  dailyDeficitLimitMinutes            Int                         @default(60) // D√©ficit m√°ximo diario sin alerta
  roundingIncrementMinutes            Int                         @default(5) // Redondeo autom√°tico
  deficitGraceMinutes                 Int                         @default(10) // Margen de d√©ficit: diferencias negativas que no penalizan
  excessGraceMinutes                  Int                         @default(15) // Margen de exceso: diferencias positivas que no acumulan
  holidayCompensationFactor           Decimal                     @default(1.50) @db.Decimal(4, 2)
  allowFlexibleWindows                Boolean                     @default(true)
  requireOvertimeAuthorization        Boolean                     @default(true)
  overtimeCalculationMode             OvertimeCalculationMode     @default(DAILY)
  overtimeApprovalMode                OvertimeApprovalMode        @default(POST)
  overtimeCompensationType            OvertimeCompensationType    @default(TIME)
  overtimeToleranceMinutes            Int                         @default(15)
  overtimeDailyLimitMinutes           Int                         @default(0)
  overtimeWeeklyLimitMinutes          Int                         @default(0)
  overtimeMonthlyLimitMinutes         Int                         @default(0)
  overtimeAnnualLimitMinutes          Int                         @default(0)
  overtimeFullTimeWeeklyHours         Int                         @default(40)
  overtimeNonWorkingDayPolicy         OvertimeNonWorkingDayPolicy @default(REQUIRE_APPROVAL)
  overtimeWeeklyReconciliationEnabled Boolean                     @default(true)
  autoCloseMissingClockOut            Boolean                     @default(true)
  allowCashConversion                 Boolean                     @default(false)
  approvalFlow                        TimeBankApprovalFlow        @default(MIRROR_PTO)
  metadata                            Json?
  createdAt                           DateTime                    @default(now())
  updatedAt                           DateTime                    @updatedAt

  createdById String?
  createdBy   User?   @relation("TimeBankSettingsCreatedBy", fields: [createdById], references: [id])

  updatedById String?
  updatedBy   User?   @relation("TimeBankSettingsUpdatedBy", fields: [updatedById], references: [id])

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("time_bank_settings")
}

model OvertimeCandidate {
  id                    String                   @id @default(cuid())
  date                  DateTime // D√≠a al que corresponde el c√°lculo
  expectedMinutes       Int?
  workedMinutes         Int
  deviationMinutesRaw   Int
  candidateMinutesRaw   Int
  candidateMinutesFinal Int?
  calculationMode       OvertimeCalculationMode
  approvalMode          OvertimeApprovalMode
  compensationType      OvertimeCompensationType
  requiresApproval      Boolean                  @default(false)
  status                OvertimeCandidateStatus  @default(PENDING_CALC)
  candidateType         OvertimeCandidateType    @default(EXTRA)
  flags                 Json?
  policySnapshot        Json?
  lastCalculatedAt      DateTime?
  resolvedAt            DateTime?

  workdaySummaryId String?         @unique
  workdaySummary   WorkdaySummary? @relation("WorkdayOvertimeCandidate", fields: [workdaySummaryId], references: [id], onDelete: SetNull)

  overworkAuthorizationId String?                @unique
  overworkAuthorization   OverworkAuthorization? @relation(fields: [overworkAuthorizationId], references: [id], onDelete: SetNull)

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, employeeId, date])
  @@index([orgId, status])
  @@index([employeeId, date])
  @@map("overtime_candidates")
}

model TimeBankMovement {
  id               String                 @id @default(cuid())
  date             DateTime // D√≠a al que corresponde el movimiento
  minutes          Int // Positivo = suma, negativo = resta
  type             TimeBankMovementType   @default(EXTRA)
  origin           TimeBankMovementOrigin @default(AUTO_DAILY)
  status           TimeBankMovementStatus @default(SETTLED)
  requiresApproval Boolean                @default(false)
  description      String?
  referenceId      String? // ID externo (fichaje, solicitud, regla)
  metadata         Json?

  workdayId String?
  workday   WorkdaySummary? @relation(fields: [workdayId], references: [id], onDelete: SetNull)

  requestId String?          @unique
  request   TimeBankRequest? @relation("RequestMovement", fields: [requestId], references: [id], onDelete: SetNull)

  overworkAuthorizationId String?                @unique
  overworkAuthorization   OverworkAuthorization? @relation("OverworkMovement", fields: [overworkAuthorizationId], references: [id], onDelete: SetNull)

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation("TimeBankMovementCreator", fields: [createdById], references: [id])

  approvedById String?
  approvedBy   User?     @relation("TimeBankMovementApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, employeeId, date])
  @@index([workdayId])
  @@index([requestId])
  @@index([overworkAuthorizationId])
  @@index([status])
  @@map("time_bank_movements")
}

model TimeBankRequest {
  id               String                @id @default(cuid())
  type             TimeBankRequestType   @default(RECOVERY)
  status           TimeBankRequestStatus @default(PENDING)
  requestedMinutes Int // Minutos absolutos solicitados
  date             DateTime // Fecha objetivo
  reason           String?
  attachments      String[]              @default([])
  metadata         Json?
  submittedAt      DateTime? // Fecha en la que el empleado la envi√≥
  approvedAt       DateTime?
  rejectedAt       DateTime?
  processedAt      DateTime?

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  reviewerId String?
  reviewer   User?   @relation("TimeBankRequestReviewer", fields: [reviewerId], references: [id])

  processedById String?
  processedBy   User?   @relation("TimeBankRequestProcessor", fields: [processedById], references: [id])

  movement TimeBankMovement? @relation("RequestMovement")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, employeeId, status])
  @@index([reviewerId])
  @@index([submittedAt])
  @@map("time_bank_requests")
}

model OverworkAuthorization {
  id               String                      @id @default(cuid())
  date             DateTime // D√≠a autorizado
  minutesApproved  Int // Minutos autorizados
  justification    String?
  compensationType OvertimeCompensationType    @default(TIME)
  status           OverworkAuthorizationStatus @default(PENDING)
  requestedAt      DateTime                    @default(now())
  resolvedAt       DateTime?

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  requestedById String
  requestedBy   User   @relation("OverworkAuthorizationRequester", fields: [requestedById], references: [id])

  approvedById String?
  approvedBy   User?   @relation("OverworkAuthorizationApprover", fields: [approvedById], references: [id])

  movement TimeBankMovement? @relation("OverworkMovement")

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  OvertimeCandidate OvertimeCandidate?

  @@index([orgId, employeeId, status])
  @@index([requestedById])
  @@index([approvedById])
  @@map("overwork_authorizations")
}

enum TimeBankMovementType {
  EXTRA // Horas extra
  DEFICIT // Horas de menos
  FESTIVE // Festivo trabajado/compensado
  ADJUSTMENT // Ajuste manual o RRHH
  RECOVERY // Recuperaci√≥n/bolsa usada
  FLEX // Jornada flexible / compactaci√≥n
  CORRECTION // Correcci√≥n autom√°tica
}

enum TimeBankMovementOrigin {
  AUTO_DAILY // Diferencia autom√°tica (resumen diario)
  AUTO_FESTIVE // Festivo detectado autom√°ticamente
  AUTO_DEFICIT // Penalizaci√≥n autom√°tica por d√©ficit
  MANUAL_ADMIN // Ajuste manual RRHH
  EMPLOYEE_REQUEST // Solicitud del empleado
  OVERTIME_AUTHORIZATION // Horas extra autorizadas
  FLEX_WINDOW // Jornada flexible
  CORRECTION // Correcci√≥n de fichaje
}

enum TimeBankMovementStatus {
  PENDING
  APPROVED
  REJECTED
  SETTLED
}

enum TimeBankRequestType {
  RECOVERY // Solicitar salir antes usando bolsa
  FESTIVE_COMPENSATION // Cambiar festivo trabajado por libre
  CORRECTION // Correcci√≥n de fichaje que impacta saldo
}

enum TimeBankRequestStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  APPLIED
}

enum OverworkAuthorizationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

enum TimeBankApprovalFlow {
  MIRROR_PTO
  HR_ONLY
}

enum OvertimeCalculationMode {
  DAILY
  WEEKLY
  DAILY_WEEKLY
}

enum OvertimeApprovalMode {
  NONE
  POST
  PRE
}

enum OvertimeCompensationType {
  PAY
  TIME
  MIXED
  NONE
}

enum OvertimeNonWorkingDayPolicy {
  ALLOW
  REQUIRE_APPROVAL
}

enum OvertimeCandidateStatus {
  PENDING_CALC
  READY
  PENDING_APPROVAL
  SETTLED
  REJECTED
  SKIPPED
}

enum OvertimeCandidateType {
  EXTRA
  DEFICIT
  COMPLEMENTARY
  NON_WORKDAY
}

enum OvertimeCalcStatus {
  DIRTY
  CALCULATING
  READY
  PENDING_APPROVAL
  SETTLED
  SKIPPED
}

// Buckets de balance PTO
enum PtoBalanceType {
  VACATION
  PERSONAL_MATTERS
  COMP_TIME
}

// ==================== SPRINT 3: SISTEMA DE VACACIONES (PTO) ====================

// Tipos de ausencia configurables (Vacaciones, Asuntos personales, Baja m√©dica, etc.)
model AbsenceType {
  id               String  @id @default(cuid())
  name             String // "Vacaciones", "Asuntos personales", "Baja m√©dica"
  code             String // "VACATION", "PERSONAL", "SICK_LEAVE"
  description      String?
  color            String  @default("#3b82f6") // Color para identificaci√≥n visual
  isPaid           Boolean @default(true) // Si es tiempo pagado o no
  requiresApproval Boolean @default(true) // Si requiere aprobaci√≥n
  minDaysAdvance   Int     @default(0) // D√≠as de anticipaci√≥n requeridos
  affectsBalance   Boolean @default(true) // Si descuenta del balance de PTO
  active           Boolean @default(true)

  // üÜï GRANULARIDAD - Para soportar ausencias en minutos/horas (sector privado/p√∫blico)
  allowPartialDays       Boolean @default(false) // ¬øPermite fracciones de d√≠a?
  countsCalendarDays     Boolean @default(false) // // Si cuenta d√≠as naturales (bajas m√©dicas, permisos naturales)
  granularityMinutes     Int     @default(480) // Granularidad: 480=d√≠a, 60=hora, 30=media, 15=cuarto
  minimumDurationMinutes Int     @default(480) // Duraci√≥n m√≠nima en minutos
  maxDurationMinutes     Int? // Duraci√≥n m√°xima (null=sin l√≠mite)

  // üÜï FUTURO - Factor de compensaci√≥n para nocturnidad/festivos (polic√≠a, bomberos)
  compensationFactor Decimal @default(1.0) @db.Decimal(3, 2) // 1.0=normal, 1.5=nocturno, 1.75=festivo

  // üÜï SISTEMA DE BALANCE EN MINUTOS - ¬øA qu√© contador de balance afecta?
  balanceType PtoBalanceType @default(VACATION) // Bucket de balance

  // üÜï MEJORA 2: Justificantes de ausencias
  requiresDocument Boolean @default(false) // ¬øRequiere justificante obligatorio para enviar la solicitud?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  ptoRequests PtoRequest[]

  @@unique([orgId, code]) // C√≥digo √∫nico por organizaci√≥n
  @@index([orgId])
  @@index([active])
  @@map("absence_types")
}

// Balance de d√≠as de PTO por empleado y a√±o
model PtoBalance {
  id          String         @id @default(cuid())
  year        Int // A√±o al que aplica el balance
  balanceType PtoBalanceType @default(VACATION)

  // ‚ùå DEPRECAR (mantener temporalmente para migraci√≥n y reportes legacy)
  annualAllowance Decimal @db.Decimal(5, 2) // D√≠as asignados este a√±o (puede ser proporcional)
  daysUsed        Decimal @default(0) @db.Decimal(5, 2) // D√≠as ya usados (solicitudes aprobadas)
  daysPending     Decimal @default(0) @db.Decimal(5, 2) // D√≠as en solicitudes pendientes
  daysAvailable   Decimal @db.Decimal(5, 2) // Disponibles = allowance - used - pending

  // ‚úÖ NUEVOS CAMPOS (en minutos) - PRINCIPAL
  annualAllowanceMinutes Int @default(0) // 22 d√≠as √ó workdayMinutes
  minutesUsed            Int @default(0) // Vacaciones usadas
  minutesPending         Int @default(0) // Solicitudes pendientes
  minutesAvailable       Int @default(0) // Disponibles

  // ‚úÖ NUEVOS: Contadores separados por tipo (Opci√≥n R√°pida - v1)
  compensatedMinutes     Int @default(0) // D√≠as compensados (festivos, nocturnos, guardias)
  freeDisposalMinutes    Int @default(0) // Horas de libre disposici√≥n (horas extra, etc.)
  personalMattersMinutes Int @default(0) // Asuntos propios (separado de vacaciones)

  // ‚úÖ SNAPSHOT: Minutos de jornada usados para el c√°lculo (hist√≥rico)
  workdayMinutesSnapshot Int @default(480) // Jornada en minutos del a√±o calculado

  // Metadata para auditor√≠a y c√°lculo proporcional
  calculationDate   DateTime @default(now())
  contractStartDate DateTime // Fecha de inicio del contrato para c√°lculo proporcional
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Relaciones
  adjustments PtoBalanceAdjustment[] // Ajustes manuales realizados a este balance

  @@unique([orgId, employeeId, year, balanceType]) // Un balance por empleado por a√±o y bucket
  @@index([orgId])
  @@index([employeeId])
  @@index([year])
  @@map("pto_balances")
}

// Solicitudes de ausencia (PTO)
model PtoRequest {
  id String @id @default(cuid())

  // Fechas y d√≠as
  startDate   DateTime // Fecha de inicio
  endDate     DateTime // Fecha de fin
  workingDays Decimal  @db.Decimal(5, 2) // D√≠as h√°biles calculados (excluyendo festivos y fines de semana)

  // üÜï FRANJAS HORARIAS - Para ausencias parciales (sector privado: "30 min de 14:00 a 14:30")
  startTime       Int? // Minutos desde medianoche (540 = 09:00, null = d√≠a completo)
  endTime         Int? // Minutos desde medianoche (1020 = 17:00, null = d√≠a completo)
  durationMinutes Int? // Duraci√≥n en minutos (para c√°lculos r√°pidos)

  // üÜï SISTEMA DE BALANCE EN MINUTOS - Minutos efectivos descontados del balance
  effectiveMinutes Int @default(0) // durationMinutes √ó compensationFactor (o workingDays √ó workdayMinutes √ó compensationFactor)

  // Estado de la solicitud
  status PtoRequestStatus @default(PENDING)

  // Informaci√≥n adicional
  reason        String? // Motivo de la ausencia
  attachmentUrl String? // URL del archivo adjunto (opcional)
  internalNotes String? // Notas internas (solo RRHH)

  // Aprobaci√≥n (UN solo aprobador)
  approverId       String?
  approver         User?     @relation("PtoApprover", fields: [approverId], references: [id])
  approvedAt       DateTime?
  approverComments String? // Comentarios del aprobador al aprobar

  // Auditor√≠a - Qui√©n cre√≥ la solicitud
  createdById String?
  createdBy   User?   @relation("PtoRequestCreator", fields: [createdById], references: [id])

  // Rechazo
  rejectedAt      DateTime?
  rejectionReason String? // Motivo del rechazo

  // Cancelaci√≥n
  cancelledAt        DateTime?
  cancellationReason String? // Motivo de la cancelaci√≥n

  // Timestamps
  submittedAt DateTime @default(now()) // Cuando se envi√≥ la solicitud
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado que solicita
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Tipo de ausencia
  absenceTypeId String
  absenceType   AbsenceType @relation(fields: [absenceTypeId], references: [id])

  // Relaciones
  notifications PtoNotification[]
  documents     PtoRequestDocument[] // üÜï Justificantes adjuntos

  @@index([orgId])
  @@index([employeeId])
  @@index([approverId])
  @@index([createdById])
  @@index([status])
  @@index([startDate])
  @@index([submittedAt])
  // √çndices compuestos para reportes (FASE 3 - Organizaci√≥n)
  @@index([employeeId, startDate, endDate]) // Vacaciones por empleado y rango
  @@index([orgId, status, startDate]) // Reportes de solicitudes pendientes
  @@index([employeeId, status]) // Estado de vacaciones por empleado
  @@map("pto_requests")
}

// üÜï MEJORA 2: Justificantes de ausencias - Documentos adjuntos a solicitudes PTO
model PtoRequestDocument {
  id String @id @default(cuid())

  // Relaci√≥n con la solicitud
  ptoRequestId String
  ptoRequest   PtoRequest @relation(fields: [ptoRequestId], references: [id], onDelete: Cascade)

  // Archivo
  fileName     String // Nombre original del archivo
  filePath     String // Ruta en storage (org-X/pto-requests/Y/archivo.pdf)
  fileSize     Int // Tama√±o en bytes
  mimeType     String // "application/pdf", "image/jpeg", "image/png"
  storedFileId String?
  storedFile   StoredFile? @relation(fields: [storedFileId], references: [id], onDelete: SetNull)

  // Auditor√≠a
  uploadedById String // Usuario que subi√≥ el archivo
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  uploadedAt   DateTime @default(now())

  // Metadata opcional
  description String? // Descripci√≥n del documento

  @@index([ptoRequestId])
  @@index([uploadedById])
  @@index([storedFileId])
  @@map("pto_request_documents")
}

// Estados de solicitud de PTO
enum PtoRequestStatus {
  DRAFT // Borrador (no enviada a√∫n)
  PENDING // Pendiente de aprobaci√≥n
  APPROVED // Aprobada
  REJECTED // Rechazada
  CANCELLED // Cancelada por el empleado
}

// Notificaciones del sistema (PTO y futuras funcionalidades)
model PtoNotification {
  id      String              @id @default(cuid())
  type    PtoNotificationType // Tipo de notificaci√≥n
  title   String // T√≠tulo corto
  message String // Mensaje descriptivo
  isRead  Boolean             @default(false)

  // Solicitud relacionada (opcional)
  ptoRequestId String?
  ptoRequest   PtoRequest? @relation(fields: [ptoRequestId], references: [id], onDelete: Cascade)

  // Solicitud de fichaje manual relacionada (opcional)
  manualTimeEntryRequestId String?
  manualTimeEntryRequest   ManualTimeEntryRequest? @relation(fields: [manualTimeEntryRequestId], references: [id], onDelete: Cascade)

  // Gasto relacionado (opcional)
  expenseId String?
  expense   Expense? @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Destinatario de la notificaci√≥n
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([ptoRequestId])
  @@index([manualTimeEntryRequestId])
  @@index([expenseId])
  @@map("pto_notifications")
}

// Tipos de notificaciones
enum PtoNotificationType {
  PTO_SUBMITTED // Nueva solicitud enviada (notificar aprobador)
  PTO_APPROVED // Solicitud aprobada (notificar empleado)
  PTO_REJECTED // Solicitud rechazada (notificar empleado)
  PTO_CANCELLED // Solicitud cancelada (notificar aprobador)
  PTO_REMINDER // Recordatorio de solicitud sin revisar
  DOCUMENT_UPLOADED // Nuevo documento subido (futuro)
  SYSTEM_ANNOUNCEMENT // Anuncio del sistema (futuro)
  SIGNATURE_PENDING // Nueva solicitud de firma asignada
  SIGNATURE_COMPLETED // Documento firmado exitosamente
  SIGNATURE_REJECTED // Documento rechazado por firmante
  SIGNATURE_EXPIRED // Documento expirado sin firmar
  MANUAL_TIME_ENTRY_SUBMITTED // Nueva solicitud de fichaje manual enviada
  MANUAL_TIME_ENTRY_APPROVED // Solicitud de fichaje manual aprobada
  MANUAL_TIME_ENTRY_REJECTED // Solicitud de fichaje manual rechazada
  TIME_ENTRY_EXCESSIVE // Fichaje excede 150% de jornada laboral (requiere regularizaci√≥n)
  EXPENSE_SUBMITTED // Nueva solicitud de gasto
  EXPENSE_APPROVED // Gasto aprobado
  EXPENSE_REJECTED // Gasto rechazado
  EXPENSE_REIMBURSED // Gasto reembolsado
  TIME_BANK_REQUEST_SUBMITTED // Nueva solicitud de bolsa enviada
  TIME_BANK_REQUEST_APPROVED // Solicitud de bolsa aprobada
  TIME_BANK_REQUEST_REJECTED // Solicitud de bolsa rechazada
  OVERTIME_PENDING_APPROVAL // Hora extra pendiente de aprobaci√≥n
  OVERTIME_APPROVED // Hora extra aprobada
  OVERTIME_REJECTED // Hora extra rechazada
  OVERTIME_ADJUSTED // Hora extra ajustada por correcci√≥n
  PAYSLIP_AVAILABLE // N√≥mina disponible para el empleado
  SIGNATURE_REMINDER // Recordatorio de firma pendiente (antes de expirar)
}

// Estado del lote de firmas masivas
enum SignatureBatchStatus {
  DRAFT // Configurando, sin SignatureRequest creadas
  ACTIVE // SignatureRequest creadas y en curso
  COMPLETED // Todos firmaron o cerrado manualmente
  CANCELLED // Cancelado por HR/Admin
  EXPIRED // expiresAt alcanzado
}

// Rol del segundo firmante en doble firma
enum SecondSignerRole {
  MANAGER // Manager directo del empleado
  HR // Cualquier usuario con rol HR
  SPECIFIC_USER // Usuario espec√≠fico (secondSignerUserId)
}

// Ajustes manuales de balance de PTO (auditor√≠a)
model PtoBalanceAdjustment {
  id String @id @default(cuid())

  // Tipo de ajuste
  adjustmentType PtoAdjustmentType

  // Cantidad (positiva o negativa)
  daysAdjusted Decimal @db.Decimal(5, 2)

  // Justificaci√≥n
  reason String // Motivo corto obligatorio
  notes  String? // Notas adicionales opcionales

  // Auditor√≠a
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Balance afectado
  ptoBalanceId String
  ptoBalance   PtoBalance @relation(fields: [ptoBalanceId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([ptoBalanceId])
  @@index([createdById])
  @@index([createdAt])
  @@map("pto_balance_adjustments")
}

// Tipos de ajuste de balance
enum PtoAdjustmentType {
  MANUAL_ADD // A√±adir d√≠as manualmente
  MANUAL_SUBTRACT // Quitar d√≠as manualmente
  SENIORITY_BONUS // D√≠as por antig√ºedad
  COLLECTIVE_AGREEMENT // D√≠as por convenio colectivo
  COMPENSATION // Compensaci√≥n
  CORRECTION // Correcci√≥n de error
  MATERNITY_LEAVE // Baja maternal registrada
  PATERNITY_LEAVE // Baja paternal registrada
  SICK_LEAVE // Baja m√©dica registrada
  OTHER // Otro tipo de ajuste
}

// Pol√≠tica de acumulaci√≥n de vacaciones
enum PtoCarryoverMode {
  NONE // No acumular al siguiente a√±o
  UNTIL_DATE // Acumular hasta una fecha l√≠mite
  UNLIMITED // Acumular indefinidamente
}

// Pol√≠tica de redondeo de vacaciones
enum PtoRoundingMode {
  DOWN // Redondeo a la baja
  NEAREST // Redondeo al m√°s cercano
  UP // Redondeo al alza
}

// Configuraci√≥n de PTO por organizaci√≥n
model OrganizationPtoConfig {
  id String @id @default(cuid())

  // Multi-tenancy (relaci√≥n 1:1)
  orgId        String       @unique
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Configuraci√≥n de bajas legisladas (en semanas)
  maternityLeaveWeeks Int @default(17) // Baja maternal
  paternityLeaveWeeks Int @default(17) // Baja paternal

  // D√≠as adicionales por antig√ºedad (JSON con reglas)
  // Formato: [{yearsFrom: 5, yearsTo: 10, extraDays: 2}, {yearsFrom: 10, yearsTo: null, extraDays: 4}]
  seniorityRules Json @default("[]")

  // Otras configuraciones
  allowNegativeBalance          Boolean          @default(false) // Permitir balance negativo
  maxAdvanceRequestMonths       Int              @default(12) // Meses m√°ximos de anticipaci√≥n
  carryoverMode                 PtoCarryoverMode @default(NONE) // Pol√≠tica de acumulaci√≥n
  carryoverDeadlineMonth        Int              @default(1) // Mes l√≠mite de disfrute (1-12)
  carryoverDeadlineDay          Int              @default(29) // D√≠a l√≠mite de disfrute (1-31)
  carryoverRequestDeadlineMonth Int              @default(1) // Mes l√≠mite de solicitud (1-12)
  carryoverRequestDeadlineDay   Int              @default(29) // D√≠a l√≠mite de solicitud (1-31)
  vacationRoundingUnit          Decimal          @default(0.1) @db.Decimal(4, 2) // Granularidad (0.1, 0.5, 1.0)
  vacationRoundingMode          PtoRoundingMode  @default(NEAREST) // Redondeo de d√≠as de vacaciones
  personalMattersDays           Decimal          @default(0) @db.Decimal(5, 2) // Asuntos propios anuales
  compTimeDays                  Decimal          @default(0) @db.Decimal(5, 2) // Compensaci√≥n anual (d√≠as)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organization_pto_config")
}

// Ajustes recurrentes de PTO (se aplican autom√°ticamente cada a√±o)
model RecurringPtoAdjustment {
  id String @id @default(cuid())

  // Cantidad de d√≠as adicionales cada a√±o
  extraDays   Decimal        @db.Decimal(5, 2)
  balanceType PtoBalanceType @default(VACATION)

  // Tipo y justificaci√≥n
  adjustmentType PtoAdjustmentType
  reason         String // Motivo corto obligatorio
  notes          String? // Notas adicionales opcionales

  // Control
  active    Boolean @default(true)
  startYear Int // Desde qu√© a√±o aplica (ej: 2025)

  // Auditor√≠a
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([employeeId])
  @@index([active])
  @@index([startYear])
  @@map("recurring_pto_adjustments")
}

// ==================== SISTEMA DE FIRMA ELECTR√ìNICA ====================

// Documento firmable - PDF que requiere firma(s)
model SignableDocument {
  id          String  @id @default(cuid())
  title       String // T√≠tulo del documento
  description String? // Descripci√≥n opcional
  category    String // CONTRATO, NOMINA, ACUERDO, POLITICA, OTRO

  // Archivo original
  originalFileUrl String // URL en Azure Blob del PDF original
  originalHash    String // SHA-256 del archivo original
  fileSize        Int // Tama√±o en bytes
  mimeType        String      @default("application/pdf")
  storedFileId    String?
  storedFile      StoredFile? @relation(fields: [storedFileId], references: [id], onDelete: SetNull)

  // Versi√≥n y metadatos
  version   Int       @default(1)
  expiresAt DateTime? // Fecha de vencimiento opcional

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Creador del documento
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Relaciones
  signatureRequests SignatureRequest[]
  signatureBatches  SignatureBatch[]

  @@index([orgId])
  @@index([createdById])
  @@index([category])
  @@index([storedFileId])
  @@map("signable_documents")
}

// Lote de firmas masivas - Agrupa m√∫ltiples SignatureRequest
model SignatureBatch {
  id          String  @id @default(cuid())
  name        String // Nombre del lote (ej: "Pol√≠tica de privacidad 2024")
  description String? // Descripci√≥n opcional

  // Estado del lote
  status SignatureBatchStatus @default(DRAFT)

  // Documento base a firmar
  documentId String
  document   SignableDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Configuraci√≥n de doble firma
  requireDoubleSignature Boolean           @default(false)
  secondSignerRole       SecondSignerRole? // MANAGER, HR o SPECIFIC_USER
  secondSignerUserId     String? // ID del usuario espec√≠fico (si role = SPECIFIC_USER)
  secondSignerUser       User?             @relation("SecondSignerBatches", fields: [secondSignerUserId], references: [id])

  // Expiraci√≥n y recordatorios
  expiresAt      DateTime
  reminderDays   Int[]     @default([7, 3, 1]) // D√≠as antes de expirar para enviar recordatorio
  lastReminderAt DateTime? // √öltima vez que se enviaron recordatorios

  // Estad√≠sticas desnormalizadas (se actualizan al cambiar estado de SignatureRequest)
  totalRecipients Int @default(0)
  signedCount     Int @default(0)
  pendingCount    Int @default(0)
  rejectedCount   Int @default(0)

  // Auditor√≠a
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("CreatedBatches", fields: [createdById], references: [id])

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  requests SignatureRequest[]

  @@index([orgId, status])
  @@index([documentId])
  @@index([createdById])
  @@index([expiresAt])
  @@map("signature_batches")
}

// Solicitud de firma - Workflow de firma con m√∫ltiples firmantes
model SignatureRequest {
  id String @id @default(cuid())

  // Estado general de la solicitud
  status SignatureRequestStatus @default(PENDING)

  // Pol√≠tica de firma aplicada
  policy String @default("SES") // SES, SES_TOTP (futuro)

  // Fecha l√≠mite para completar todas las firmas
  expiresAt DateTime

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime? // Cuando se completaron todas las firmas

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Documento a firmar
  documentId String
  document   SignableDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Lote de firmas (opcional - puede ser solicitud individual)
  batchId String?
  batch   SignatureBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)

  // Flag para doble firma cuando no hay segundo firmante asignado
  secondSignerMissing Boolean @default(false) // true si MANAGER y no tiene manager

  // Relaciones
  signers   Signer[]
  evidences SignatureEvidence[]

  @@index([orgId])
  @@index([documentId])
  @@index([status])
  @@index([expiresAt])
  @@index([batchId])
  @@map("signature_requests")
}

// Firmante individual - Cada persona que debe firmar
model Signer {
  id String @id @default(cuid())

  // Orden de firma (1, 2, 3... para firma secuencial)
  order Int @default(1)

  // Estado del firmante
  status SignerStatus @default(PENDING)

  // Token √∫nico para acceder a la sesi√≥n de firma
  signToken String @unique

  // Empleado que debe firmar
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Datos de la firma
  signedAt      DateTime? // Momento de la firma
  signedFileUrl String? // URL del PDF firmado (solo el √∫ltimo firmante genera el final)
  signedHash    String? // Hash SHA-256 del PDF firmado

  // Consentimiento (paso 1 del flujo)
  consentGivenAt DateTime? // Cuando marc√≥ el checkbox de consentimiento
  ipAddress      String? // IP desde donde firm√≥
  userAgent      String? // User agent del navegador

  // Rechazo
  rejectedAt      DateTime?
  rejectionReason String? // Motivo del rechazo

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con la solicitud
  requestId String
  request   SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Relaciones
  evidences SignatureEvidence[]

  @@index([requestId])
  @@index([employeeId])
  @@index([status])
  @@index([signToken])
  @@map("signers")
}

// Evidencia de firma - Registro inmutable de auditor√≠a
model SignatureEvidence {
  id String @id @default(cuid())

  // Timeline completo de eventos (JSON array)
  // Formato: [{event: "CREATED", timestamp: "...", user: "..."}, {...}]
  timeline Json

  // Hashes para verificaci√≥n de integridad
  preSignHash  String // Hash del PDF antes de la firma
  postSignHash String? // Hash del PDF despu√©s de la firma (null si rechazado)

  // Metadatos del firmante (JSON)
  // Formato: {ip: "...", userAgent: "...", geolocation: {...}, sessionId: "..."}
  signerMetadata Json

  // Pol√≠tica de firma aplicada
  policy String // SES, SES_TOTP

  // Resultado de la firma
  result SignatureResult

  // Timestamps
  createdAt DateTime @default(now())

  // Relaciones
  requestId String
  request   SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  signerId String
  signer   Signer @relation(fields: [signerId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([signerId])
  @@index([result])
  @@index([createdAt])
  @@map("signature_evidences")
}

// Estados de solicitud de firma
enum SignatureRequestStatus {
  PENDING // Pendiente (ninguna firma completada)
  IN_PROGRESS // En progreso (algunas firmas completadas)
  COMPLETED // Completada (todas las firmas completadas)
  REJECTED // Rechazada (alg√∫n firmante rechaz√≥)
  EXPIRED // Expirada (venci√≥ sin completarse)
}

// Estados de firmante individual
enum SignerStatus {
  PENDING // Pendiente de firmar
  SIGNED // Firmado exitosamente
  REJECTED // Rechazado por el firmante
  EXPIRED // No firm√≥ antes del vencimiento
}

// Resultado de la evidencia
enum SignatureResult {
  SUCCESS // Firma exitosa
  REJECTED // Firma rechazada
  EXPIRED // Expir√≥ sin firmar
  ERROR // Error durante el proceso
}

// ==================== SISTEMA DE FICHAJES MANUALES (A POSTERIORI) ====================

// Solicitud de fichaje manual - Cuando un empleado olvid√≥ fichar
model ManualTimeEntryRequest {
  id String @id @default(cuid())

  // Fechas y horas solicitadas
  date         DateTime // Fecha del fichaje olvidado (sin hora, solo d√≠a)
  clockInTime  DateTime // Hora de entrada solicitada
  clockOutTime DateTime // Hora de salida solicitada

  // Justificaci√≥n
  reason String // Motivo obligatorio

  // Estado de la solicitud
  status ManualTimeEntryStatus @default(PENDING)

  // Aprobaci√≥n (UN solo aprobador - el manager del empleado)
  approverId       String?
  approver         User?     @relation("ManualTimeEntryApprover", fields: [approverId], references: [id])
  approvedAt       DateTime?
  approverComments String? // Comentarios del aprobador al aprobar

  // Rechazo
  rejectedAt      DateTime?
  rejectionReason String? // Motivo del rechazo

  // TimeEntries creados (si se aprueba)
  createdClockInId  String? // ID del TimeEntry de entrada creado
  createdClockOutId String? // ID del TimeEntry de salida creado

  // Reemplazo de fichajes incompletos
  replacesIncompleteEntry Boolean  @default(false) // Indica si reemplaza un fichaje abierto
  replacedEntryIds        String[] @default([]) // IDs de las entradas que se reemplazan
  warningMessage          String? // Mensaje de advertencia mostrado al usuario

  // Slots detallados (WORK / BREAK) para solicitudes con pausas
  slots ManualTimeEntrySlot[]

  // Timestamps
  submittedAt DateTime @default(now()) // Cuando se envi√≥ la solicitud
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado solicitante
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Notificaciones relacionadas
  notifications PtoNotification[]

  @@index([orgId])
  @@index([employeeId])
  @@index([approverId])
  @@index([status])
  @@index([date])
  @@index([submittedAt])
  @@map("manual_time_entry_requests")
}

model ManualTimeEntrySlot {
  id String @id @default(cuid())

  requestId String
  request   ManualTimeEntryRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  slotType     TimeSlotType
  startMinutes Int
  endMinutes   Int
  sortOrder    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestId])
  @@map("manual_time_entry_slots")
}

// Estados de solicitud de fichaje manual
enum ManualTimeEntryStatus {
  PENDING // Pendiente de aprobaci√≥n
  APPROVED // Aprobado
  REJECTED // Rechazado
}

// ==================== M√ìDULO DE GESTI√ìN DE GASTOS ====================

// Estados del expediente de gasto (Sector P√∫blico)
enum ProcedureStatus {
  DRAFT // Borrador
  PENDING_AUTHORIZATION // Pendiente de autorizaci√≥n previa
  AUTHORIZED // Autorizado (listo para recibir gastos)
  JUSTIFICATION_PENDING // Gastos realizados, pendiente de revisar justificaci√≥n
  JUSTIFIED // Justificaci√≥n aprobada
  CLOSED // Cerrado
  REJECTED // Rechazado
}

// Qui√©n paga el gasto
enum ExpensePayer {
  EMPLOYEE // El empleado pag√≥ (reembolsable)
  ORGANIZATION // La organizaci√≥n pag√≥ (pago directo, tarjeta empresa, agencia)
}

// Expediente de Gasto (Comisi√≥n de servicio / Provisi√≥n de fondos)
model ExpenseProcedure {
  id          String  @id @default(cuid())
  code        String? // C√≥digo visual (ej: EXP-2024-001)
  name        String // T√≠tulo (ej: "Viaje Congreso Madrid")
  description String?

  status ProcedureStatus @default(DRAFT)

  // Fechas del expediente (ej: fechas del viaje)
  startDate DateTime?
  endDate   DateTime?

  // Control econ√≥mico
  estimatedAmount Decimal? @db.Decimal(10, 2) // Presupuesto estimado/autorizado
  approvedAmount  Decimal? @db.Decimal(10, 2) // Importe final aprobado

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Beneficiario (Empleado)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Creador (puede ser un administrativo, no necesariamente el empleado)
  createdById String
  createdBy   User   @relation("ProcedureCreator", fields: [createdById], references: [id])

  // Auditor√≠a
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  expenses Expense[] // Gastos imputados a este expediente
  history  ExpenseProcedureHistory[] // Historial de cambios y estados

  @@index([orgId])
  @@index([employeeId])
  @@index([status])
  @@map("expense_procedures")
}

// Historial de cambios de estado del expediente (Auditor√≠a)
model ExpenseProcedureHistory {
  id String @id @default(cuid())

  procedureId String
  procedure   ExpenseProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  // Qu√© pas√≥
  action String // "CREATED", "STATUS_CHANGE", "UPDATED", "ASSIGNED"

  // Transici√≥n de estado (si aplica)
  previousStatus ProcedureStatus?
  newStatus      ProcedureStatus?

  // Detalles
  comment String? // Comentario opcional (ej: motivo rechazo)
  details String? // Detalles t√©cnicos o resumen de cambios

  // Qui√©n lo hizo
  actorId String
  actor   User   @relation(fields: [actorId], references: [id])

  createdAt DateTime @default(now())

  @@index([procedureId])
  @@index([actorId])
  @@map("expense_procedure_history")
}

// Aprobadores organizacionales de gastos (sistema multi-aprobador flexible)
model ExpenseApprover {
  id String @id @default(cuid())

  userId String
  user   User   @relation("ExpenseApproverRoles", fields: [userId], references: [id], onDelete: Cascade)

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false) // Marcar como aprobador principal (opcional)
  order     Int     @default(0) // Orden de prioridad para UI (drag & drop)

  createdAt DateTime @default(now())

  @@unique([userId, orgId]) // Un usuario solo puede ser aprobador 1 vez por org
  @@index([orgId])
  @@index([userId])
  @@map("expense_approvers")
}

enum ExpenseStatus {
  DRAFT // Borrador (no enviado)
  SUBMITTED // Enviado a aprobaci√≥n
  APPROVED // Aprobado por manager
  REJECTED // Rechazado
  REIMBURSED // Reembolsado
}

enum ExpenseCategory {
  FUEL // Combustible
  MILEAGE // Kilometraje
  MEAL // Comidas
  TOLL // Peajes
  PARKING // Parking
  LODGING // Alojamiento
  OTHER // Otros
}

enum ApprovalDecision {
  PENDING // Pendiente
  APPROVED // Aprobado
  REJECTED // Rechazado
}

enum ReimbursementMethod {
  TRANSFER // Transferencia bancaria
  PAYROLL // N√≥mina
  CASH // Efectivo
  OTHER // Otro m√©todo
}

// Gasto individual
model Expense {
  id String @id @default(cuid())

  // Datos del gasto
  date        DateTime // Fecha del gasto
  currency    String          @default("EUR")
  amount      Decimal         @db.Decimal(10, 2) // Importe base sin IVA
  vatPercent  Decimal?        @db.Decimal(5, 2) // % IVA (ej: 21.00)
  totalAmount Decimal         @db.Decimal(10, 2) // Total = amount + IVA
  category    ExpenseCategory

  // Kilometraje (solo si category = MILEAGE)
  mileageKm   Decimal? @db.Decimal(10, 2)
  mileageRate Decimal? @db.Decimal(5, 3) // ‚Ç¨/km aplicado

  // Clasificaci√≥n
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Notas y metadata
  notes        String?
  merchantName String? // Nombre del comercio (OCR)
  merchantVat  String? // CIF/NIF del comercio (OCR)
  ocrRawData   Json? // Datos brutos del OCR para auditor√≠a

  // Estado
  status ExpenseStatus @default(DRAFT)

  // Reembolso
  reimbursedAt           DateTime?
  reimbursedBy           String?
  reimbursedByUser       User?                @relation("ExpenseReimburser", fields: [reimbursedBy], references: [id])
  reimbursementMethod    ReimbursementMethod?
  reimbursementReference String? // N¬∫ transferencia o referencia

  // Auditor√≠a
  createdBy String
  creator   User     @relation("ExpenseCreator", fields: [createdBy], references: [id])
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado que crea el gasto
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Informe de gastos (opcional)
  reportId String?
  report   ExpenseReport? @relation(fields: [reportId], references: [id])

  // Relaciones
  attachments ExpenseAttachment[]
  approvals   ExpenseApproval[]

  // Relaci√≥n con Expediente (Sector P√∫blico)
  procedureId String?
  procedure   ExpenseProcedure? @relation(fields: [procedureId], references: [id])

  // Qui√©n pag√≥ (Para distinguir reembolso vs pago directo)
  paidBy ExpensePayer @default(EMPLOYEE)

  policySnapshot PolicySnapshot?
  notifications  PtoNotification[]

  @@index([orgId])
  @@index([employeeId])
  @@index([status])
  @@index([category])
  @@index([date])
  @@index([reportId])
  @@map("expenses")
}

// Adjuntos del gasto (tickets, facturas)
model ExpenseAttachment {
  id           String      @id @default(cuid())
  url          String // URL en storage
  fileName     String
  mimeType     String?
  fileSize     Int
  storedFileId String?
  storedFile   StoredFile? @relation(fields: [storedFileId], references: [id], onDelete: SetNull)
  createdAt    DateTime    @default(now())

  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([storedFileId])
  @@map("expense_attachments")
}

// Aprobaci√≥n de gasto (preparado para multi-nivel)
model ExpenseApproval {
  id        String           @id @default(cuid())
  decision  ApprovalDecision @default(PENDING)
  comment   String?
  decidedAt DateTime?
  level     Int              @default(1) // Nivel de aprobaci√≥n (1, 2, 3...)

  approverId String
  approver   User   @relation(fields: [approverId], references: [id])

  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([approverId])
  @@index([decision])
  @@map("expense_approvals")
}

// Informe de gastos (agrupar varios gastos)
model ExpenseReport {
  id          String   @id @default(cuid())
  title       String
  description String?
  periodFrom  DateTime
  periodTo    DateTime
  status      String   @default("OPEN") // OPEN, SUBMITTED, APPROVED, REJECTED
  total       Decimal  @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Propietario del informe
  ownerId String
  owner   Employee @relation(fields: [ownerId], references: [id])

  // Gastos incluidos
  expenses Expense[]

  @@index([orgId])
  @@index([ownerId])
  @@index([status])
  @@map("expense_reports")
}

// Snapshot de pol√≠tica aplicada al gasto (auditor√≠a)
model PolicySnapshot {
  id                  String   @id @default(cuid())
  mileageRateEurPerKm Decimal? @db.Decimal(5, 3)
  mealDailyLimit      Decimal? @db.Decimal(10, 2)
  lodgingDailyLimit   Decimal? @db.Decimal(10, 2)
  fuelRequiresReceipt Boolean  @default(true)
  vatAllowed          Boolean  @default(true)
  costCenterRequired  Boolean  @default(false)

  expenseId String  @unique
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@map("policy_snapshots")
}

// Pol√≠tica de gastos por organizaci√≥n
model ExpensePolicy {
  id String @id @default(cuid())

  // Tarifas y l√≠mites
  mileageRateEurPerKm Decimal  @default(0.26) @db.Decimal(5, 3)
  mealDailyLimit      Decimal? @db.Decimal(10, 2)
  lodgingDailyLimit   Decimal? @db.Decimal(10, 2)

  // Requisitos por categor√≠a (JSON)
  // Formato: { FUEL: { requiresReceipt: true, vatAllowed: true }, ... }
  categoryRequirements Json @default("{}")

  // Configuraci√≥n general
  attachmentRequired Boolean @default(true)
  costCenterRequired Boolean @default(false)
  vatAllowed         Boolean @default(true)

  // Aprobaci√≥n
  approvalLevels Int @default(1) // Niveles de aprobaci√≥n (1, 2, 3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy (1:1 con Organization)
  orgId        String       @unique
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("expense_policies")
}

// ==================== SISTEMA DE GEOLOCALIZACI√ìN ====================

// Consentimiento de geolocalizaci√≥n del usuario (RGPD)
model GeolocationConsent {
  id String @id @default(cuid())

  // Consentimiento
  consentGivenAt DateTime @default(now()) // Fecha y hora del consentimiento
  consentVersion String   @default("1.0") // Versi√≥n del texto de consentimiento
  ipAddress      String? // IP desde donde se dio consentimiento
  active         Boolean  @default(true) // Si el consentimiento est√° activo (puede revocarse)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Usuario que dio consentimiento
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId]) // Un consentimiento activo por usuario por organizaci√≥n
  @@index([orgId])
  @@index([userId])
  @@index([active])
  @@map("geolocation_consents")
}

// ==================== SISTEMA DE AUDITOR√çA DE ACCESO A DATOS SENSIBLES ====================

// Log de auditor√≠a para acceso a datos sensibles (IBAN, salario, etc.)
model SensitiveDataAccess {
  id String @id @default(cuid())

  // Tipo de dato sensible accedido
  dataType SensitiveDataType

  // Referencia al recurso (ID del empleado, etc.)
  resourceId   String
  resourceType String // "EMPLOYEE", "CONTRACT", etc.

  // Usuario que accedi√≥
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Metadatos del acceso
  ipAddress String?
  userAgent String?

  // Timestamp
  accessedAt DateTime @default(now())

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([resourceId])
  @@index([dataType])
  @@index([accessedAt])
  @@map("sensitive_data_access")
}

// Tipos de datos sensibles
enum SensitiveDataType {
  IBAN // Datos bancarios
  SALARY // Salario
  SSN // N√∫mero seguridad social
  MEDICAL_DATA // Datos m√©dicos
  OTHER // Otros datos sensibles
}

// ==================== M√ìDULO DE CHAT 1:1 ====================

// Conversaci√≥n 1:1 entre dos usuarios
model Conversation {
  id String @id @default(cuid())

  // Usuarios participantes (normalizados: userAId < userBId siempre para evitar duplicados)
  userAId String
  userBId String

  // Metadata
  lastMessageAt DateTime @default(now())
  isBlocked     Boolean  @default(false)

  // Contadores de mensajes no le√≠dos por usuario
  unreadCountUserA Int @default(0) // Mensajes no le√≠dos para userA
  unreadCountUserB Int @default(0) // Mensajes no le√≠dos para userB

  // Estado de visibilidad por usuario (para ocultar conversaciones)
  hiddenByUserA Boolean @default(false) // UserA ocult√≥ la conversaci√≥n
  hiddenByUserB Boolean @default(false) // UserB ocult√≥ la conversaci√≥n

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones con usuarios
  userA User @relation("ConversationUserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB User @relation("ConversationUserB", fields: [userBId], references: [id], onDelete: Cascade)

  // Mensajes de la conversaci√≥n
  messages Message[]

  @@unique([orgId, userAId, userBId]) // Conversaci√≥n √∫nica por par de usuarios en la organizaci√≥n
  @@index([orgId])
  @@index([userAId])
  @@index([userBId])
  @@index([lastMessageAt])
  @@map("conversations")
}

// Mensaje individual dentro de una conversaci√≥n
model Message {
  id String @id @default(cuid())

  // Contenido (m√°ximo 2KB seg√∫n requisitos)
  body String @db.Text

  // Estado del mensaje
  status MessageStatus @default(SENT)

  // Timestamps
  createdAt DateTime  @default(now())
  editedAt  DateTime? // Si fue editado
  deletedAt DateTime? // Soft delete

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Conversaci√≥n a la que pertenece
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Remitente del mensaje
  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([conversationId, createdAt]) // √çndice compuesto para paginaci√≥n eficiente
  @@map("messages")
}

// Estados del mensaje
enum MessageStatus {
  SENT // Enviado
  READ // Le√≠do
}

// ==================== NOTIFICACIONES DESCARTADAS ====================

// Sistema de descarte de notificaciones (fichajes incompletos, etc.)
model DismissedNotification {
  id          String   @id @default(cuid())
  type        String // "INCOMPLETE_ENTRY", "EXCESSIVE_TIME", etc.
  referenceId String // ID del WorkdaySummary o TimeEntry
  dismissedAt DateTime @default(now())

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Usuario que descart√≥ la notificaci√≥n
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, referenceId])
  @@index([userId, type])
  @@index([orgId])
  @@map("dismissed_notifications")
}

// ==================== SISTEMA DE HORARIOS V2.0 - FLEXIBLE ====================

// Plantilla de horario base (Ej: "Horario Oficina", "Turno Noche", "Patr√≥n Polic√≠a")
model ScheduleTemplate {
  id           String               @id @default(cuid())
  name         String // "Horario oficina central", "Turno 24h bomberos"
  description  String?
  templateType ScheduleTemplateType // FIXED, SHIFT, ROTATION, FLEXIBLE
  weeklyHours  Decimal?             @db.Decimal(5, 2) // Objetivo semanal (FLEXIBLE total)
  isActive     Boolean              @default(true)

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  periods             SchedulePeriod[]
  employeeAssignments EmployeeScheduleAssignment[]
  manualAssignments   ManualShiftAssignment[]
  rotationSteps       ShiftRotationStep[]
  exceptionDays       ExceptionDayOverride[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@map("schedule_templates")
}

// Periodo de vigencia (REGULAR, INTENSIVE/verano, SPECIAL/Semana Santa)
model SchedulePeriod {
  id                 String           @id @default(cuid())
  scheduleTemplateId String
  scheduleTemplate   ScheduleTemplate @relation(fields: [scheduleTemplateId], references: [id], onDelete: Cascade)

  periodType  SchedulePeriodType
  name        String? // "Verano 2025", "Semana Santa", "Campa√±a Navidad"
  weeklyHours Decimal?           @db.Decimal(5, 2) // Objetivo semanal (solo FLEXIBLE total)

  // Fechas de vigencia (null = permanente/REGULAR)
  validFrom DateTime? // null = desde siempre
  validTo   DateTime? // null = hasta siempre

  // Patr√≥n de d√≠as laborables
  workDayPatterns WorkDayPattern[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduleTemplateId])
  @@map("schedule_periods")
}

// Patr√≥n de d√≠a de semana (L-V 9-18h, S√°bados 10-14h, etc.)
model WorkDayPattern {
  id               String         @id @default(cuid())
  schedulePeriodId String
  schedulePeriod   SchedulePeriod @relation(fields: [schedulePeriodId], references: [id], onDelete: Cascade)

  dayOfWeek    Int // 0=Domingo, 1=Lunes, ..., 6=S√°bado (ISO 8601)
  isWorkingDay Boolean @default(true)

  // Tramos horarios de ese d√≠a
  timeSlots TimeSlot[]

  @@index([schedulePeriodId])
  @@map("work_day_patterns")
}

// Tramo horario (09:00-14:00 WORK MANDATORY, 14:00-15:00 BREAK, etc.)
model TimeSlot {
  id               String         @id @default(cuid())
  workDayPatternId String
  workDayPattern   WorkDayPattern @relation(fields: [workDayPatternId], references: [id], onDelete: Cascade)

  startTimeMinutes Int // 0-1440 (minutos desde medianoche)
  endTimeMinutes   Int // 0-1440

  slotType     TimeSlotType @default(WORK)
  presenceType PresenceType @default(MANDATORY) // MANDATORY (presencia obligatoria) o FLEXIBLE

  // Configuraci√≥n ON_CALL - permite determinar si este slot cuenta como trabajo esperado
  countsAsWork       Boolean @default(true) // TRUE para WORK normal, configurable para ON_CALL
  compensationFactor Decimal @default(1.00) @db.Decimal(4, 2) // 1.00 = normal, 1.50 = nocturno, 1.75 = festivo

  description String? // "Pausa comida", "Guardia localizada"

  // Pausas Autom√°ticas (Mejora 6) - Solo aplica cuando slotType=BREAK
  isAutomatic Boolean @default(false) // Si esta pausa se registra autom√°ticamente al clockOut

  @@index([workDayPatternId])
  @@map("time_slots")
}

// Asignaci√≥n manual de turno (Planificaci√≥n/Rostering)
model ManualShiftAssignment {
  id String @id @default(cuid())

  // Empleado asignado
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Turno asignado (Plantilla)
  scheduleTemplateId String?
  scheduleTemplate   ScheduleTemplate? @relation(fields: [scheduleTemplateId], references: [id])

  // Fecha de asignaci√≥n
  date DateTime @db.Date

  // Override opcional de horario (si es distinto al template)
  startTimeMinutes Int?
  endTimeMinutes   Int?

  // Ubicaci√≥n espec√≠fica para este turno (Multicentro)
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // Zona espec√≠fica dentro del centro (Barra, Cocina, etc.)
  workZoneId String?
  workZone   WorkZone? @relation(fields: [workZoneId], references: [id])

  // Datos adicionales para planificaci√≥n manual
  breakMinutes Int?
  customRole   String?
  notes        String?
  status       ManualShiftStatus @default(DRAFT)
  publishedAt  DateTime?

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date]) // Un turno principal por d√≠a
  @@index([orgId])
  @@index([scheduleTemplateId])
  @@index([costCenterId])
  @@index([workZoneId])
  @@index([status])
  @@index([date])
  // √çndices compuestos para reportes (FASE 3 - Organizaci√≥n)
  @@index([orgId, date]) // Cuadrante diario (todos los turnos de un d√≠a)
  @@index([orgId, date, status]) // Cuadrante publicado de un d√≠a
  @@index([costCenterId, date]) // Turnos por centro y d√≠a
  @@map("manual_shift_assignments")
}

// Plantilla simple de turnos manuales (patrones M-T-N-L, etc.)
model ManualShiftTemplate {
  id                   String   @id @default(cuid())
  name                 String
  description          String?
  pattern              String[]
  shiftDurationMinutes Int      @default(480)
  color                String?
  isActive             Boolean  @default(true)

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@map("manual_shift_templates")
}

// Zona de trabajo (sub-ubicaci√≥n dentro de un centro de coste)
model WorkZone {
  id          String  @id @default(cuid())
  name        String // "Barra", "Cocina", "Terraza"
  description String?

  // Configuraci√≥n de cobertura (JSON)
  // { morning: 2, afternoon: 3, night: 1 }
  requiredCoverage Json @default("{}")

  isActive Boolean @default(true)

  // Relaci√≥n con centro de coste
  costCenterId String
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  manualAssignments ManualShiftAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([costCenterId])
  @@map("work_zones")
}

// Patr√≥n de rotaci√≥n (para polic√≠a, bomberos, etc.)
model ShiftRotationPattern {
  id          String  @id @default(cuid())
  name        String // "Polic√≠a 6x6", "Bomberos 24x72"
  description String?

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Pasos de la rotaci√≥n
  steps               ShiftRotationStep[]
  employeeAssignments EmployeeScheduleAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@map("shift_rotation_patterns")
}

// Paso de rotaci√≥n (Ej: 6 d√≠as Turno Ma√±ana ‚Üí 6 d√≠as Descanso)
model ShiftRotationStep {
  id                String               @id @default(cuid())
  rotationPatternId String
  rotationPattern   ShiftRotationPattern @relation(fields: [rotationPatternId], references: [id], onDelete: Cascade)

  stepOrder    Int // Orden en la rotaci√≥n (1, 2, 3...)
  durationDays Int // Duraci√≥n en d√≠as

  scheduleTemplateId String
  scheduleTemplate   ScheduleTemplate @relation(fields: [scheduleTemplateId], references: [id])

  @@index([rotationPatternId])
  @@map("shift_rotation_steps")
}

// Asignaci√≥n de horario a empleado
model EmployeeScheduleAssignment {
  id String @id @default(cuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  assignmentType ScheduleAssignmentType

  // Para FIXED/SHIFT/FLEXIBLE
  scheduleTemplateId String?
  scheduleTemplate   ScheduleTemplate? @relation(fields: [scheduleTemplateId], references: [id])

  // Para ROTATION
  rotationPatternId String?
  rotationPattern   ShiftRotationPattern? @relation(fields: [rotationPatternId], references: [id])
  rotationStartDate DateTime? // Fecha inicio de la rotaci√≥n

  // Vigencia de la asignaci√≥n
  validFrom DateTime  @default(now())
  validTo   DateTime? // null = indefinido

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  // √çndice compuesto para consultas de asignaciones activas (FASE 4 - Robustez)
  @@index([employeeId, isActive, validFrom, validTo])
  @@map("employee_schedule_assignments")
}

// Excepci√≥n de d√≠a (para d√≠as sueltos raros: "Viernes Santo 12:48h")
model ExceptionDayOverride {
  id String @id @default(cuid())

  // Alcance de la excepci√≥n (XOR: solo uno puede estar activo)
  // 1. Empleado espec√≠fico
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // 2. Plantilla de horario (afecta a todos los empleados asignados)
  scheduleTemplateId String?
  scheduleTemplate   ScheduleTemplate? @relation(fields: [scheduleTemplateId], references: [id])

  // 3. Excepci√≥n global (toda la organizaci√≥n)
  isGlobal Boolean @default(false)

  // 4. Por departamento
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  // 5. Por centro de costes
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  date        DateTime  @db.Date // D√≠a espec√≠fico
  endDate     DateTime? @db.Date // Para rangos de fechas (opcional)
  reason      String? // "Viernes Santo", "Cierre excepcional"
  weeklyHours Decimal?  @db.Decimal(5, 2) // Objetivo semanal (solo FLEXIBLE total)

  // Tipo de excepci√≥n
  exceptionType ExceptionType

  // Recurrencia anual (para festivos que se repiten cada a√±o)
  isRecurring Boolean @default(false)

  // Slots espec√≠ficos para ese d√≠a
  overrideSlots ExceptionTimeSlot[]

  // Soft delete y auditor√≠a
  deletedAt     DateTime?
  deletedBy     String?
  deletedByUser User?     @relation("DeletedExceptions", fields: [deletedBy], references: [id])

  createdBy     String
  createdByUser User   @relation("CreatedExceptions", fields: [createdBy], references: [id])

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([scheduleTemplateId])
  @@index([departmentId])
  @@index([costCenterId])
  @@index([orgId])
  @@index([date])
  @@index([isGlobal])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([deletedBy])
  @@map("exception_day_overrides")
}

// Time slot para excepci√≥n
model ExceptionTimeSlot {
  id             String               @id @default(cuid())
  exceptionDayId String
  exceptionDay   ExceptionDayOverride @relation(fields: [exceptionDayId], references: [id], onDelete: Cascade)

  startTimeMinutes Int
  endTimeMinutes   Int
  slotType         TimeSlotType
  presenceType     PresenceType

  @@index([exceptionDayId])
  @@map("exception_time_slots")
}

// ==================== SISTEMA DE EQUIPOS ====================

// Equipo - Divisi√≥n de trabajo dentro de un centro de coste
model Team {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informaci√≥n b√°sica
  name        String
  description String?
  code        String? // C√≥digo √∫nico (ej: "VEN-A", "LOG-001")

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Departamento al que pertenece (OPCIONAL - para jerarqu√≠a completa)
  // Si es null, el equipo es transversal (sin departamento)
  // VALIDACI√ìN: Si existe, department.costCenterId DEBE ser igual a costCenterId
  departmentId String?
  department   Department? @relation("DepartmentTeams", fields: [departmentId], references: [id], onDelete: SetNull)

  // Centro al que pertenece (OBLIGATORIO - siempre debe tener un centro)
  costCenterId String
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Cascade)

  // Estado
  isActive Boolean @default(true)

  // Relaciones
  employees          Employee[]          @relation("EmployeeTeam")
  areaResponsibles   AreaResponsible[]   @relation("TeamResponsibles")
  alertSubscriptions AlertSubscription[] @relation("TeamAlertSubscriptions")
  alerts             Alert[]             @relation("TeamAlerts")
  activeContexts     UserActiveContext[] @relation("UserActiveTeam")

  @@unique([orgId, code])
  @@index([orgId])
  @@index([costCenterId])
  @@index([isActive])
  @@map("teams")
}

// ==================== ENUMS PARA HORARIOS V2.0 ====================

enum ScheduleTemplateType {
  FIXED // Horario fijo (oficina, tienda)
  SHIFT // Turno (ma√±ana, tarde, noche)
  ROTATION // Rotaci√≥n (polic√≠a 6x6, bomberos 24x72)
  FLEXIBLE // Flexible (teletrabajo, aut√≥nomos)
}

enum SchedulePeriodType {
  REGULAR // Horario habitual todo el a√±o
  INTENSIVE // Jornada intensiva (verano)
  SPECIAL // Especial (Navidad, Semana Santa, campa√±as)
}

enum TimeSlotType {
  WORK // Tiempo de trabajo
  BREAK // Pausa/descanso
  ON_CALL // Guardia localizada
  OTHER // Otro
}

enum PresenceType {
  MANDATORY // Presencia obligatoria (sector p√∫blico: 9:00-14:30)
  FLEXIBLE // Flexible (sector p√∫blico: 7:00-9:00 y 14:30-16:00)
}

enum ScheduleAssignmentType {
  FIXED // Horario fijo asignado
  SHIFT // Turno asignado
  ROTATION // Rotaci√≥n asignada
  FLEXIBLE // Flexible (sin horario fijo)
}

enum ManualShiftStatus {
  DRAFT
  PUBLISHED
  CONFLICT
}

enum ExceptionType {
  HOLIDAY // Festivo (d√≠a completo sin trabajo)
  REDUCED_HOURS // Jornada reducida
  SPECIAL_SCHEDULE // Horario especial
  TRAINING // Formaci√≥n/Evento
  EARLY_CLOSURE // Cierre anticipado
  CUSTOM // Personalizado
}

// ==================== SISTEMA DE PROYECTOS (Mejora 4) ====================

enum ProjectAccessType {
  OPEN // Todos los empleados pueden fichar en este proyecto
  ASSIGNED // Solo empleados asignados pueden fichar
}

model Project {
  id          String  @id @default(cuid())
  name        String
  code        String? // C√≥digo corto (ej: "PROJ-001")
  description String?
  color       String? // Color para UI (hex)

  // Tipo de acceso
  accessType ProjectAccessType @default(OPEN)

  // Estado
  isActive Boolean @default(true) // false = no permite nuevos fichajes pero aparece en hist√≥ricos

  // Multi-tenant
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Relaciones
  assignments ProjectAssignment[]
  timeEntries TimeEntry[]

  // Auditor√≠a
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, name]) // Nombre √∫nico por organizaci√≥n
  @@unique([orgId, code]) // C√≥digo √∫nico por organizaci√≥n (si se usa)
  @@index([orgId])
  @@index([isActive])
  @@map("projects")
}

model ProjectAssignment {
  id String @id @default(cuid())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Metadatos
  role       String? // Rol en el proyecto (opcional)
  assignedAt DateTime @default(now())

  @@unique([projectId, employeeId])
  @@index([projectId])
  @@index([employeeId])
  @@map("project_assignments")
}

// ==================== SISTEMA DE PERMISOS POR √ÅMBITO Y ALERTAS ====================

// Responsabilidades de usuario por √°mbito (manager de centro, departamento, etc.)
model AreaResponsible {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Usuario responsable
  userId String
  user   User   @relation("UserAreaResponsibilities", fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // √Åmbito de responsabilidad (solo uno debe estar presente)
  scope String // "ORGANIZATION" | "DEPARTMENT" | "COST_CENTER" | "TEAM"

  // Relaci√≥n con departamento (solo si scope = DEPARTMENT)
  departmentId String?
  department   Department? @relation("DepartmentResponsibles", fields: [departmentId], references: [id], onDelete: Cascade)

  // Relaci√≥n con centro de coste (solo si scope = COST_CENTER)
  costCenterId String?
  costCenter   CostCenter? @relation("CostCenterResponsibles", fields: [costCenterId], references: [id], onDelete: Cascade)

  // Relaci√≥n con equipo (solo si scope = TEAM)
  teamId String?
  team   Team?   @relation("TeamResponsibles", fields: [teamId], references: [id], onDelete: Cascade)

  // Permisos espec√≠ficos para este √°mbito (array de strings)
  // Ej: ["VIEW_EMPLOYEES", "MANAGE_SCHEDULES", "RESOLVE_ALERTS", "VIEW_ALERTS"]
  permissions String[]

  // Estado
  isActive Boolean @default(true)

  @@unique([userId, scope, departmentId, costCenterId, teamId])
  @@index([userId])
  @@index([orgId])
  @@index([departmentId])
  @@index([costCenterId])
  @@index([teamId])
  @@index([isActive])
  @@map("area_responsibles")
}

// Suscripciones a notificaciones de alertas (flexible: responsables o personas individuales)
model AlertSubscription {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Usuario suscrito
  userId String
  user   User   @relation("UserAlertSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // √Åmbito de suscripci√≥n (recibe alertas de...)
  // NOTA: Las suscripciones son ACUMULATIVAS - un usuario con m√∫ltiples suscripciones ve TODAS las alertas de todas ellas (sin duplicar)
  scope String // "ORGANIZATION" | "DEPARTMENT" | "COST_CENTER" | "TEAM"

  // Relaci√≥n con departamento (solo si scope = DEPARTMENT)
  departmentId String?
  department   Department? @relation("DepartmentAlertSubscriptions", fields: [departmentId], references: [id], onDelete: Cascade)

  // Relaci√≥n con centro de coste (solo si scope = COST_CENTER)
  costCenterId String?
  costCenter   CostCenter? @relation("CostCenterAlertSubscriptions", fields: [costCenterId], references: [id], onDelete: Cascade)

  // Relaci√≥n con equipo (solo si scope = TEAM)
  teamId String?
  team   Team?   @relation("TeamAlertSubscriptions", fields: [teamId], references: [id], onDelete: Cascade)

  // Configuraci√≥n de notificaciones (MVP V1: predefinidas, no configurables)
  // Tipos de alertas que quiere recibir (vac√≠o = todas)
  alertTypes String[] @default([]) // ["LATE_ARRIVAL", "EARLY_DEPARTURE", "ABSENCE", etc.]

  // Severidades que quiere recibir (vac√≠o = todas)
  severityLevels String[] @default([]) // ["WARNING", "CRITICAL"]

  // Canales de notificaci√≥n
  notifyInApp   Boolean @default(true) // Notificaci√≥n en navbar
  notifyByEmail Boolean @default(false) // Email autom√°tico (futuro)

  // Control de volumen (futuro V2/V3)
  maxAlertsPerDay     Int? // L√≠mite diario
  digestMode          Boolean @default(false) // Agrupar en resumen diario
  digestTime          String? // "09:00" - Hora del resumen
  onlyFirstOccurrence Boolean @default(false) // Solo notificar la primera vez

  // Sobrescritura de usuario (futuro)
  isUserOverride Boolean @default(false) // True si el usuario la modific√≥ manualmente
  isDisabled     Boolean @default(false) // True si el usuario la desactiv√≥ expl√≠citamente

  // Estado
  isActive Boolean @default(true)

  @@unique([userId, scope, departmentId, costCenterId, teamId])
  @@index([userId])
  @@index([orgId])
  @@index([departmentId])
  @@index([costCenterId])
  @@index([teamId])
  @@index([isActive])
  @@map("alert_subscriptions")
}

// Alertas de fichajes detectadas autom√°ticamente
model Alert {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Empleado afectado
  employeeId String
  employee   Employee @relation("EmployeeAlerts", fields: [employeeId], references: [id], onDelete: Cascade)

  // Tipo de alerta
  type     String // "LATE_ARRIVAL" | "CRITICAL_LATE_ARRIVAL" | "EARLY_DEPARTURE" | "CRITICAL_EARLY_DEPARTURE" | "ABSENCE_NO_JUSTIFY" | etc.
  severity String // "INFO" | "WARNING" | "CRITICAL"

  // Detalles
  title       String // "Entrada tarde: 35 minutos de retraso"
  description String? // Descripci√≥n detallada
  date        DateTime // Fecha del evento (d√≠a sin hora)

  // Contexto (fichaje relacionado)
  timeEntryId String?
  timeEntry   TimeEntry? @relation("TimeEntryAlerts", fields: [timeEntryId], references: [id])

  workdaySummaryId String?
  workdaySummary   WorkdaySummary? @relation("WorkdayAlerts", fields: [workdaySummaryId], references: [id])

  // Datos de desviaci√≥n
  deviationMinutes Int? // Minutos de desviaci√≥n (si aplica)

  // Detalles de incidencias diarias (para alertas tipo DAILY_SUMMARY)
  // Estructura JSON con todas las incidencias del d√≠a
  incidents Json? // { lateArrivals: [{time, deviation, severity}], earlyDepartures: [], etc. }

  // √Åmbito de la alerta (para filtrado) - Centro/Depto en el MOMENTO de crear la alerta
  costCenterId         String? // Centro ACTUAL del empleado
  originalCostCenterId String? // Centro en el momento de la alerta (hist√≥rico, inmutable)

  costCenter         CostCenter? @relation("AlertCostCenter", fields: [costCenterId], references: [id])
  originalCostCenter CostCenter? @relation("AlertOriginalCostCenter", fields: [originalCostCenterId], references: [id])

  // Relaci√≥n con departamento (para filtrado y suscripciones por departamento)
  departmentId String?
  department   Department? @relation("DepartmentAlerts", fields: [departmentId], references: [id])

  // Relaci√≥n con equipo (para filtrado por equipo)
  teamId String?
  team   Team?   @relation("TeamAlerts", fields: [teamId], references: [id])

  // Estado
  status String @default("ACTIVE") // "ACTIVE" | "RESOLVED" | "DISMISSED"

  resolvedAt DateTime?
  resolvedBy String?
  resolver   User?     @relation("AlertResolver", fields: [resolvedBy], references: [id])

  resolutionComment String? // Justificaci√≥n al resolver

  // Notificaciones enviadas
  notifiedUsers String[] @default([]) // IDs de usuarios notificados

  // Asignaciones y notas internas
  assignments AlertAssignment[]
  notes       AlertNote[]

  // Constraint √∫nico para alertas resumen diarias
  // Solo puede haber UNA alerta DAILY_SUMMARY por empleado por d√≠a
  @@unique([employeeId, date, type])
  // √çndices para rendimiento
  @@index([orgId])
  @@index([employeeId])
  @@index([departmentId])
  @@index([costCenterId])
  @@index([originalCostCenterId])
  @@index([teamId])
  @@index([status])
  @@index([date])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@index([timeEntryId])
  // √çndices compuestos para queries comunes
  @@index([orgId, status, severity]) // Dashboard principal
  @@index([costCenterId, status, date]) // Dashboard de centro
  @@index([teamId, status, date]) // Dashboard de equipo
  @@index([employeeId, date, type]) // Deduplicaci√≥n
  @@map("alerts")
}

// Asignaciones de alertas (una alerta puede tener varios responsables asignados)
model AlertAssignment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("AlertAssignmentUser", fields: [userId], references: [id], onDelete: Cascade)

  assignedById String?
  assignedBy   User?   @relation("AlertAssignmentAssignedBy", fields: [assignedById], references: [id])

  // Motivo/origen de la asignaci√≥n
  source String // "DIRECT_MANAGER" | "TEAM_RESPONSIBLE" | "DEPARTMENT_RESPONSIBLE" | "COST_CENTER_RESPONSIBLE" | "ORG_RESPONSIBLE" | "HR_FALLBACK" | "MANUAL"

  @@unique([alertId, userId])
  @@index([alertId])
  @@index([userId])
  @@map("alert_assignments")
}

// Notas internas de alertas
model AlertNote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("AlertNoteAuthor", fields: [userId], references: [id], onDelete: Cascade)

  content String

  @@index([alertId])
  @@index([userId])
  @@map("alert_notes")
}

// Contexto activo del usuario para filtrado de vistas
// Permite a usuarios con m√∫ltiples responsabilidades elegir qu√© √°mbito ver
model UserActiveContext {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Usuario (uno a uno)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenancy
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Contexto activo seleccionado por el usuario
  activeScope String @default("ALL") // "ALL" | "ORGANIZATION" | "DEPARTMENT" | "COST_CENTER" | "TEAM"

  // ID del √°mbito activo (solo si activeScope != "ALL" y != "ORGANIZATION")
  activeDepartmentId String?
  activeDepartment   Department? @relation("UserActiveDepartment", fields: [activeDepartmentId], references: [id])

  activeCostCenterId String?
  activeCostCenter   CostCenter? @relation("UserActiveCostCenter", fields: [activeCostCenterId], references: [id])

  activeTeamId String?
  activeTeam   Team?   @relation("UserActiveTeam", fields: [activeTeamId], references: [id])

  // √çndices para rendimiento
  @@index([userId])
  @@index([orgId])
  @@index([activeScope])
  @@map("user_active_contexts")
}

// ==================== AUDIT LOG ====================
// Registro de acciones administrativas cr√≠ticas

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Acci√≥n realizada
  action   String // DELETE_EMPLOYEE, DEACTIVATE_USER, etc.
  category String // EMPLOYEE, USER, ORGANIZATION, etc.

  // Datos de la entidad afectada (guardados como snapshot)
  entityId   String // ID de la entidad afectada
  entityType String // Tipo de entidad (Employee, User, etc.)
  entityData Json? // Snapshot de los datos antes de la acci√≥n

  // Descripci√≥n legible
  description String

  // Usuario que realiz√≥ la acci√≥n
  performedById    String
  performedByEmail String
  performedByName  String
  performedByRole  String

  // Organizaci√≥n (para filtrar por tenant)
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Metadatos adicionales
  ipAddress String?
  userAgent String?

  @@index([orgId])
  @@index([createdAt])
  @@index([action])
  @@index([performedById])
  @@map("audit_logs")
}

// ==================== IMPORTACI√ìN MASIVA DE EMPLEADOS ====================

enum EmployeeImportJobStatus {
  DRAFT
  VALIDATED
  RUNNING
  DONE
  FAILED
}

enum EmployeeImportRowStatus {
  PENDING
  READY
  SKIPPED
  ERROR
  IMPORTED
  FAILED
}

model EmployeeImportJob {
  id           String                  @id @default(cuid())
  status       EmployeeImportJobStatus @default(DRAFT)
  options      Json                    @default("{}") // vacationMode, sendInvites, duplicatePolicy, etc.
  filePath     String?
  fileName     String?
  fileHash     String?
  totalRows    Int                     @default(0)
  readyRows    Int                     @default(0)
  skippedRows  Int                     @default(0)
  warningRows  Int                     @default(0)
  errorRows    Int                     @default(0)
  importedRows Int                     @default(0)
  failedRows   Int                     @default(0)
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  validatedAt  DateTime?
  completedAt  DateTime?

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  rows EmployeeImportRow[]

  @@index([orgId])
  @@index([status])
  @@map("employee_import_jobs")
}

model EmployeeImportRow {
  id                String                  @id @default(cuid())
  rowIndex          Int
  rowHash           String?
  rawData           Json
  status            EmployeeImportRowStatus @default(PENDING)
  messages          Json                    @default("[]") // [{ type, field?, message }]
  errorReason       String?
  createdEmployeeId String?
  createdUserId     String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  jobId String
  job   EmployeeImportJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, rowIndex])
  @@index([jobId, status])
  @@map("employee_import_rows")
}

// ==================== WIZARD DE ORGANIZACIONES ====================

enum OrganizationSetupStatus {
  DRAFT
  COMPLETED
  FAILED
}

model OrganizationSetupJob {
  id        String                  @id @default(cuid())
  status    OrganizationSetupStatus @default(DRAFT)
  payload   Json                    @default("{}")
  notes     String?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  orgId        String?
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([createdById])
  @@map("organization_setup_jobs")
}

// ==================== CANAL DE DENUNCIAS (Ley 2/2023) ====================

// Tipo de informante
enum ReporterType {
  EMPLOYEE // Empleado autenticado
  EXTERNAL // Proveedor/cliente sin cuenta
  ANONYMOUS // Sin identificaci√≥n
}

// Estado de la denuncia (MVP: solo 4 estados)
enum WhistleblowingStatus {
  SUBMITTED // Enviada (estado inicial)
  IN_REVIEW // En investigaci√≥n
  RESOLVED // Resuelta
  CLOSED // Cerrada
}

// Prioridad de la denuncia
enum WhistleblowingPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Tipo de resoluci√≥n
enum ResolutionType {
  SUBSTANTIATED // Fundada
  UNSUBSTANTIATED // No fundada
  PARTIALLY_SUBSTANTIATED // Parcialmente fundada
  NO_ACTION // Sin acci√≥n requerida
}

// Tipos de actividad en denuncias (incluye notas internas)
enum WhistleblowingActivityType {
  CREATED
  SUBMITTED
  ASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  DOCUMENT_ADDED
  INTERNAL_NOTE // Reemplaza a Comment en MVP
  RESOLVED
  CLOSED
}

// Categor√≠as de denuncias
model WhistleblowingCategory {
  id               String  @id @default(cuid())
  name             String
  description      String?
  requiresEvidence Boolean @default(false)
  active           Boolean @default(true)
  order            Int     @default(0)

  orgId        String
  organization Organization           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  reports      WhistleblowingReport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@map("whistleblowing_categories")
}

// Denuncias
model WhistleblowingReport {
  id String @id @default(cuid())

  // Tracking y acceso an√≥nimo
  trackingCode   String  @unique // WB-YYYYMMDD-XXXXX (visible al usuario)
  accessCodeHash String? // SOLO hash bcrypt, nunca el c√≥digo en claro

  // Informante (simplificado)
  reporterType         ReporterType
  reporterDisplayLabel String?      @db.Text // "Empleado interno", "Proveedor", "An√≥nimo"
  reporterMetadata     String?      @db.Text // JSON cifrado (email, tel√©fono, etc.)

  // Contenido de la denuncia
  title            String
  description      String    @db.Text
  involvedParties  String?   @db.Text // JSON cifrado
  incidentDate     DateTime?
  incidentLocation String?

  // Estado y prioridad
  status   WhistleblowingStatus   @default(SUBMITTED)
  priority WhistleblowingPriority @default(MEDIUM)

  // Asignaci√≥n (campo, no estado separado)
  assignedToId String?
  assignedTo   User?     @relation("WhistleblowingAssignee", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  // Resoluci√≥n
  resolution     String?         @db.Text
  resolutionType ResolutionType?
  resolvedAt     DateTime?
  resolvedById   String?
  resolvedBy     User?           @relation("WhistleblowingResolver", fields: [resolvedById], references: [id])

  // Cierre
  closedAt   DateTime?
  closedById String?
  closedBy   User?     @relation("WhistleblowingCloser", fields: [closedById], references: [id])

  // Timestamps
  submittedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  categoryId   String
  category     WhistleblowingCategory @relation(fields: [categoryId], references: [id])
  employeeId   String? // Solo si reporterType = EMPLOYEE
  employee     Employee?              @relation(fields: [employeeId], references: [id])
  orgId        String
  organization Organization           @relation(fields: [orgId], references: [id], onDelete: Cascade)

  documents  WhistleblowingDocument[]
  activities WhistleblowingActivity[]

  @@index([orgId, status])
  @@index([trackingCode])
  @@index([assignedToId])
  @@map("whistleblowing_reports")
}

// Documentos adjuntos a denuncias
model WhistleblowingDocument {
  id String @id @default(cuid())

  reportId String
  report   WhistleblowingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  fileName     String
  filePath     String // Ruta cifrada en storage
  fileSize     Int
  mimeType     String
  description  String?
  storedFileId String?
  storedFile   StoredFile? @relation(fields: [storedFileId], references: [id], onDelete: SetNull)

  uploadedById String? // null si an√≥nimo
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id])
  uploadedAt   DateTime @default(now())

  @@index([reportId])
  @@index([storedFileId])
  @@map("whistleblowing_documents")
}

// Actividades y notas internas de denuncias
model WhistleblowingActivity {
  id String @id @default(cuid())

  reportId String
  report   WhistleblowingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  type        WhistleblowingActivityType
  description String                     @db.Text // Para INTERNAL_NOTE, el contenido de la nota
  oldValue    String? // Para cambios de estado/prioridad
  newValue    String?

  performedById String? // null si acci√≥n an√≥nima
  performedBy   User?    @relation(fields: [performedById], references: [id])
  performedAt   DateTime @default(now())
  ipAddress     String? // Para auditor√≠a de an√≥nimos

  @@index([reportId])
  @@map("whistleblowing_activities")
}

// ==================== EMAIL SYSTEM ====================
// Log de correos enviados para auditor√≠a y soporte

model EmailLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Destinatario principal
  toEmail String
  toName  String?

  // Contexto de negocio (opcionales)
  userId String?
  orgId  String?

  // Plantilla / prop√≥sito
  templateId String? // ej: "AUTH_INVITE", "AUTH_RESET_PASSWORD"
  subject    String

  // Estado del env√≠o
  status     String // "SUCCESS" | "ERROR"
  provider   String? // "resend"
  providerId String? // id devuelto por el proveedor

  errorCode    String?
  errorMessage String?

  metadata Json?

  @@index([userId])
  @@index([orgId])
  @@index([templateId])
  @@index([createdAt])
  @@map("email_logs")
}

// ==================== PR√ìXIMOS SPRINTS ====================
// Sprint 5: A√±adir PayrollExport y configuraciones
